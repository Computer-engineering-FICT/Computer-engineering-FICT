<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<HTML>
<HEAD>
<TITLE>SWI-Prolog HTTP support</TITLE><STYLE type="text/css">
/* Style sheet for SWI-Prolog latex2html
*/

dd.defbody
{ margin-bottom: 1em;
}

dt.pubdef
{ background-color: #c5e1ff;
}

.bib dd
{ margin-bottom: 1em;
}

.bib dt
{ float: left;
margin-right: 1.3ex;
}

pre.code
{ margin-left: 1.5em;
margin-right: 1.5em;
border: 1px dotted;
padding-top: 5px;
padding-left: 5px;
padding-bottom: 5px;
background-color: #f8f8f8;
}

div.navigate
{ text-align: center;
background-color: #f0f0f0;
border: 1px dotted;
padding: 5px;
}

div.title
{ text-align: center;
padding-bottom: 1em;
font-size: 200%;
font-weight: bold;
}

div.author
{ text-align: center;
font-style: italic;
}

div.abstract
{ margin-top: 2em;
background-color: #f0f0f0;
border: 1px dotted;
padding: 5px;
margin-left: 10%; margin-right:10%;
}

div.abstract-title
{ text-align: center;
padding: 5px;
font-size: 120%;
font-weight: bold;
}

div.toc-h1
{ font-size: 200%;
font-weight: bold;
}

div.toc-h2
{ font-size: 120%;
font-weight: bold;
margin-left: 2em;
}

div.toc-h3
{ font-size: 100%;
font-weight: bold;
margin-left: 4em;
}

div.toc-h4
{ font-size: 100%;
margin-left: 6em;
}

span.sec-nr
{ 
}

span.sec-title
{ 
}

span.pred-ext
{ font-weight: bold;
}

span.pred-tag
{ float: right;
font-size: 80%;
font-style: italic;
color: #202020;
}

/* Footnotes */

sup.fn { color: blue; text-decoration: underline; }
span.fn-text { display: none; }
sup.fn span {display: none;}
sup:hover span 
{ display: block !important;
position: absolute; top: auto; left: auto; width: 80%;
color: #000; background: white;
border: 2px solid;
padding: 5px; margin: 10px; z-index: 100;
font-size: smaller;
}
</STYLE>
</HEAD>
<BODY BGCOLOR="white"> 

<P>
<DIV class="title">SWI-Prolog HTTP support</DIV>
<DIV class="author">Jan Wielemaker <BR>
HCS, <BR>
University of Amsterdam <BR>
The Netherlands <BR>
E-mail: <A class="url" href="mailto:J.Wielemaker@uva.nl">J.Wielemaker@uva.nl</A></DIV>
<DIV class="abstract">
<DIV class="abstract-title">Abstract</DIV> This article documents the 
package HTTP, a series of libraries for accessing data on HTTP servers 
as well as providing HTTP server capabilities from SWI-Prolog. Both 
server and client are modular libraries. The server can be operated from 
the Unix <B>inetd</B> super-daemon as well as as a stand-alone server 
that runs on all platforms supported by SWI-Prolog.
</DIV>

<H1><A NAME="document-contents">Table of Contents</A></H1>

<DIV class="toc">
<DIV class="toc-h2"><A class="sec" href="#sec:1"><SPAN class="sec-nr">1</SPAN> <SPAN class="sec-title">Introduction</SPAN></A></DIV>
<DIV class="toc-h2"><A class="sec" href="#sec:2"><SPAN class="sec-nr">2</SPAN> <SPAN class="sec-title">The 
HTTP client libraries</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:2.1"><SPAN class="sec-nr">2.1</SPAN> <SPAN class="sec-title">The <CODE>library(http/http_open)</CODE> 
library</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:2.2"><SPAN class="sec-nr">2.2</SPAN> <SPAN class="sec-title">The <CODE>library(http/http_client)</CODE> 
library</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:2.2.1"><SPAN class="sec-nr">2.2.1</SPAN> <SPAN class="sec-title">The 
MIME client plug-in</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:2.2.2"><SPAN class="sec-nr">2.2.2</SPAN> <SPAN class="sec-title">The 
SGML client plug-in</SPAN></A></DIV>
<DIV class="toc-h2"><A class="sec" href="#sec:3"><SPAN class="sec-nr">3</SPAN> <SPAN class="sec-title">The 
HTTP server libraries</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.1"><SPAN class="sec-nr">3.1</SPAN> <SPAN class="sec-title">The 
`Body'</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.1.1"><SPAN class="sec-nr">3.1.1</SPAN> <SPAN class="sec-title">Returning 
special status codes</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.2"><SPAN class="sec-nr">3.2</SPAN> <SPAN class="sec-title">Dispatching 
HTTP locations over predicates</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.3"><SPAN class="sec-nr">3.3</SPAN> <SPAN class="sec-title">HTTP 
Session management</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.4"><SPAN class="sec-nr">3.4</SPAN> <SPAN class="sec-title">HTTP 
Authentication</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.5"><SPAN class="sec-nr">3.5</SPAN> <SPAN class="sec-title">Get 
parameters from HTML forms</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.6"><SPAN class="sec-nr">3.6</SPAN> <SPAN class="sec-title">Request 
format</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.6.1"><SPAN class="sec-nr">3.6.1</SPAN> <SPAN class="sec-title">Handling 
POST requests</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.7"><SPAN class="sec-nr">3.7</SPAN> <SPAN class="sec-title">Running 
the server</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.1"><SPAN class="sec-nr">3.7.1</SPAN> <SPAN class="sec-title">Common 
server interface options</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.2"><SPAN class="sec-nr">3.7.2</SPAN> <SPAN class="sec-title">Multi-threaded 
Prolog</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.3"><SPAN class="sec-nr">3.7.3</SPAN> <SPAN class="sec-title">From 
an interactive Prolog session using XPCE</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.4"><SPAN class="sec-nr">3.7.4</SPAN> <SPAN class="sec-title">From 
(Unix) inetd</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.5"><SPAN class="sec-nr">3.7.5</SPAN> <SPAN class="sec-title">MS-Windows</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.6"><SPAN class="sec-nr">3.7.6</SPAN> <SPAN class="sec-title">As 
CGI script</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.7.7"><SPAN class="sec-nr">3.7.7</SPAN> <SPAN class="sec-title">Using 
a reverse proxy</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.8"><SPAN class="sec-nr">3.8</SPAN> <SPAN class="sec-title">The 
wrapper library</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.9"><SPAN class="sec-nr">3.9</SPAN> <SPAN class="sec-title">http_log.pl 
-- HTTP Logging module</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.10"><SPAN class="sec-nr">3.10</SPAN> <SPAN class="sec-title">Debugging 
Servers</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.11"><SPAN class="sec-nr">3.11</SPAN> <SPAN class="sec-title">Handling 
HTTP headers</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.12"><SPAN class="sec-nr">3.12</SPAN> <SPAN class="sec-title">The <CODE>library(http/html_write)</CODE> 
library</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.12.1"><SPAN class="sec-nr">3.12.1</SPAN> <SPAN class="sec-title">Emitting 
HTML documents</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.12.2"><SPAN class="sec-nr">3.12.2</SPAN> <SPAN class="sec-title">Repositioning 
HTML for CSS and javascript links</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.12.3"><SPAN class="sec-nr">3.12.3</SPAN> <SPAN class="sec-title">Adding 
rules for html//1</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.12.4"><SPAN class="sec-nr">3.12.4</SPAN> <SPAN class="sec-title">Generating 
layout</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.12.5"><SPAN class="sec-nr">3.12.5</SPAN> <SPAN class="sec-title">Examples</SPAN></A></DIV>
<DIV class="toc-h4"><A class="sec" href="#sec:3.12.6"><SPAN class="sec-nr">3.12.6</SPAN> <SPAN class="sec-title">Remarks 
on the <CODE>library(http/html_write)</CODE> library</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.13"><SPAN class="sec-nr">3.13</SPAN> <SPAN class="sec-title">http_path.pl 
-- Abstract specification of HTTP server locations</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.14"><SPAN class="sec-nr">3.14</SPAN> <SPAN class="sec-title">Security</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:3.15"><SPAN class="sec-nr">3.15</SPAN> <SPAN class="sec-title">Tips 
and tricks</SPAN></A></DIV>
<DIV class="toc-h2"><A class="sec" href="#sec:4"><SPAN class="sec-nr">4</SPAN> <SPAN class="sec-title">Transfer 
encodings</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:4.1"><SPAN class="sec-nr">4.1</SPAN> <SPAN class="sec-title">The <CODE>library(http/http_chunked)</CODE> 
library</SPAN></A></DIV>
<DIV class="toc-h2"><A class="sec" href="#sec:5"><SPAN class="sec-nr">5</SPAN> <SPAN class="sec-title">Supporting 
JSON</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:5.1"><SPAN class="sec-nr">5.1</SPAN> <SPAN class="sec-title">json.pl 
-- Reading and writing JSON serialization</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:5.2"><SPAN class="sec-nr">5.2</SPAN> <SPAN class="sec-title">json_convert.pl 
-- Convert between JSON terms and Prolog application terms</SPAN></A></DIV>
<DIV class="toc-h3"><A class="sec" href="#sec:5.3"><SPAN class="sec-nr">5.3</SPAN> <SPAN class="sec-title">http_json.pl 
-- HTTP JSON Plugin module</SPAN></A></DIV>
<DIV class="toc-h2"><A class="sec" href="#sec:6"><SPAN class="sec-nr">6</SPAN> <SPAN class="sec-title">Status</SPAN></A></DIV>
</DIV>

<P>

<H2><A NAME="sec:1"><SPAN class="sec-nr">1</SPAN> <SPAN class="sec-title">Introduction</SPAN></A></H2>

<P>The HTTP (HyperText Transfer Protocol) is the W3C standard protocol 
for transferring information between a web-client (browser) and a 
web-server. The protocol is a simple <EM>envelope</EM> protocol where 
standard name/value pairs in the header are used to split the stream 
into messages and communicate about the connection-status. Many 
languages have client and or server libraries to deal with the HTTP 
protocol, making it a suitable candidate for general purpose 
client-server applications. It is the basis of popular agent protocols 
such as <A class="url" href="http://www.w3.org/TR/SOAP">SOAP</A> and
<A class="url" href="http://www.fipa.org">FIPA</A>.

<P>In this document we describe a modular infra-structure to access 
web-servers from SWI-Prolog and turn Prolog into a web-server. The 
server code is designed to allow the same `body' to be used from an 
interactive server for debugging or providing services from otherwise 
interactive applications, run the body from an <EM>inetd</EM> 
super-server or as a CGI script behind a generic web-server.

<P>The design of this module is different from the competing XPCE-based 
HTTP server located in <CODE>library(http/httpd.pl)</CODE>, which 
intensively uses XPCE functionality to reach its goals. Using XPCE is 
not very suitable for CGI or inetd-driven servers due to required X11 
connection and much larger footprint.

<H3>Acknowledgements</H3>

<P>This work has been carried out under the following projects:
<A class="url" href="http://hcs.science.uva.nl/projects/GARP/">GARP</A>,
<A class="url" href="http://www.ins.cwi.nl/projects/MIA/">MIA</A>,
<A class="url" href="http://hcs.science.uva.nl/projects/ibrow/home.html">IBROW</A> 
and <A class="url" href="http://kits.edte.utwente.nl/">KITS</A>. The 
following people have pioneered parts of this library and contributed 
with bug-report and suggestions for improvements: Anjo Anjewierden, Bert 
Bredeweg, Wouter Jansweijer and Bob Wielinga.

<H2><A NAME="sec:2"><SPAN class="sec-nr">2</SPAN> <SPAN class="sec-title">The 
HTTP client libraries</SPAN></A></H2>

<P>This package provides two packages for building HTTP clients. The 
first,
<CODE>library(http/http_open)</CODE> is a very lightweight library for 
opening a HTTP URL address as a Prolog stream. It can only deal with the 
HTTP GET protocol. The second, <CODE>library(http/http_client)</CODE> is 
a more advanced library dealing with <EM>keep-alive</EM>, <EM>chunked 
transfer</EM> and a plug-in mechanism providing conversions based on the 
MIME content-type.

<H3><A NAME="sec:2.1"><SPAN class="sec-nr">2.1</SPAN> <SPAN class="sec-title">The <CODE>library(http/http_open)</CODE> 
library</SPAN></A></H3>

<A NAME="sec:httpopen"></A>

<P>The library <CODE>library(http/http_open)</CODE> provides a very 
simple mechanism to read data from an HTTP server using the HTTP 1.0 
protocol and HTTP GET access method. It defines one predicate:

<DL>
<DT class="pubdef"><A NAME="http_open/3"><STRONG>http_open</STRONG>(<VAR>+URL, 
-Stream, +Options</VAR>)</A></DT>
<DD class="defbody">
Open the data at the HTTP server as a Prolog stream. <VAR>URL</VAR> is 
either an atom specifying a URL or a list representing a broken-down URL 
compatible to <A NAME="idx:parseurl2:1"></A><SPAN class="pred-ext">parse_url/2</SPAN>. 
After this predicate succeeds the data can be read from <VAR>Stream</VAR>. 
After completion this stream must be closed using the built-in Prolog 
predicate <A NAME="idx:close1:2"></A><SPAN class="pred-ext">close/1</SPAN>. <VAR>Options</VAR> 
provides additional options:

<DL>
<DT><STRONG>final_url</STRONG>(<VAR>-FinalURL</VAR>)</DT>
<DD class="defbody">
Unify <VAR>FinalURL</VAR> with the final destination. This differs from 
the original <VAR>URL</VAR> if the returned head of the original 
indicates an HTTP redirect (codes 301, 302 or 303). Without a redirect,
<VAR>FinalURL</VAR> is unified with the canonical version of <VAR>URL</VAR> 
using

<PRE class="code">
        parse_url(URL, Parts),
        parse_url(FinalURL, Parts)
</PRE>

</DD>
<DT><STRONG>header</STRONG>(<VAR>+Name, -AtomValue</VAR>)</DT>
<DD class="defbody">
If provided, <VAR>AtomValue</VAR> is unified with the value of the 
indicated field in the reply header. <VAR>Name</VAR> is matched 
case-insensitive and the underscore (<CODE>_</CODE>) matches the hyphen 
(<CODE>-</CODE>). Multiple of these options may be provided to extract 
multiple header fields. If the header is not available
<VAR>AtomValue</VAR> is unified to the empty atom ('').</DD>
<DT><STRONG>method</STRONG>(<VAR>Method</VAR>)</DT>
<DD class="defbody">
One of <CODE>get</CODE> (default) or <CODE>head</CODE>. The <CODE>head</CODE> 
message can be used in combination with the <CODE>header(Name, Value)</CODE> 
option to access information on the resource without actually fetching 
the resource itself. The returned stream must be closed immediately.</DD>
<DT><STRONG>proxy</STRONG>(<VAR>+Host, +Port</VAR>)</DT>
<DD class="defbody">
Use an HTTP proxy to connect to the outside world.</DD>
<DT><STRONG>authorization</STRONG>(<VAR>+Authorization</VAR>)</DT>
<DD class="defbody">
Send authorization. Currently only supports <CODE>basic(User, Password)</CODE>. 
See also <A NAME="idx:httpsetauthorization2:3"></A><A class="pred" href="#http_set_authorization/2">http_set_authorization/2</A>.</DD>
<DT><STRONG>request_header</STRONG>(<VAR>+Name = +Value</VAR>)</DT>
<DD class="defbody">
Additional name-value parts are added in the order of appearance to the 
HTTP request header. No interpretation is done.</DD>
<DT><STRONG>size</STRONG>(<VAR>-Size</VAR>)</DT>
<DD class="defbody">
If provided <VAR>Size</VAR> is unified with the value of the
<CODE>Content-Length</CODE> fields of the reply-header.</DD>
<DT><STRONG>timeout</STRONG>(<VAR>+Timeout</VAR>)</DT>
<DD class="defbody">
If provided, set a timeout on the stream using <A NAME="idx:setstream2:4"></A><SPAN class="pred-ext">set_stream/2</SPAN>. 
With this option if no new data arrives within <VAR>Timeout</VAR> 
seconds the stream raises an exception. Default is to wait forever (<CODE>infinite</CODE>).</DD>
<DT><STRONG>user_agent</STRONG>(<VAR>+Agent</VAR>)</DT>
<DD class="defbody">
Defines the value of the <CODE>User-Agent</CODE> field of the HTTP 
header. Default is <CODE>SWI-Prolog (http://www.swi-prolog.org)</CODE>.
</DD>
</DL>

<P>Here is a simple example:

<PRE class="code">
?- http_open('http://www.swi-prolog.org/news.html', In, []),
   copy_stream_data(In, user_output),
   close(In).
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"&gt;

&lt;HTML&gt;
&lt;HEAD&gt;
&lt;TITLE&gt;News&lt;/TITLE&gt;
&lt;/HEAD&gt;
...
</PRE>

<P>The example below fetches the modification time of a web-page. Note 
that
<VAR>Modified</VAR> is <CODE>''</CODE> if the web-server does not 
provide a time-stamp for the resource. See also <A NAME="idx:parsetime2:5"></A><SPAN class="pred-ext">parse_time/2</SPAN>.

<PRE class="code">
modified(URL, Stamp) :-
        http_open(URL, In,
                  [ method(head),
                    header(last_modified, Modified)
                  ]),
        close(In),
        Modified \== '',
        parse_time(Modified, Stamp).
close(In).
</PRE>

<P>The <A NAME="idx:httpopen3:6"></A><A class="pred" href="#http_open/3">http_open/3</A> 
predicate is designed to be lightweight. The <A NAME="idx:httpget3:7"></A><A class="pred" href="#http_get/3">http_get/3</A> 
and <A NAME="idx:httppost4:8"></A><A class="pred" href="#http_post/4">http_post/4</A> 
predicates provide more powerful, but also more complicated and 
resource-intensitive alternatives to <A NAME="idx:httpopen3:9"></A><A class="pred" href="#http_open/3">http_open/3</A>. 
The
<A NAME="idx:httpopen3:10"></A><A class="pred" href="#http_open/3">http_open/3</A> 
predicate supports transfer-encoding hooks as described in
<A class="sec" href="#sec:4">section 4</A>. In particular, loading <CODE>library(http/http_chunked)</CODE> 
provides support for HTTP 1.1 chunked encoding transfer.</DD>
<DT class="pubdef"><A NAME="http_set_authorization/2"><STRONG>http_set_authorization</STRONG>(<VAR>+URLPrefix, 
+Authorization</VAR>)</A></DT>
<DD class="defbody">
Set user/password to supply with URLs that start with <VAR>URLPrefix</VAR>. 
If Authorization is the atom =|-|=, possibly defined authorization is 
cleared. For example:

<PRE class="code">
?- http_set_authorization('http://www.example.com/private/',
                          basic('John', 'Secret'))
</PRE>

<P></DD>
</DL>

<H3><A NAME="sec:2.2"><SPAN class="sec-nr">2.2</SPAN> <SPAN class="sec-title">The <CODE>library(http/http_client)</CODE> 
library</SPAN></A></H3>

<A NAME="sec:httpclient"></A>

<P>The <CODE>library(http/http_client)</CODE> library provides more 
powerful access to reading HTTP resources, providing <EM>keep-alive</EM> 
connections,
<EM>chunked</EM> transfer and conversion of the content, such as 
breaking down <EM>multipart</EM> data, parsing HTML, etc. The library 
announces itself as providing <CODE>HTTP/1.1</CODE>.

<DL>
<DT class="pubdef"><A NAME="http_get/3"><STRONG>http_get</STRONG>(<VAR>+URL, 
-Reply, +Options</VAR>)</A></DT>
<DD class="defbody">
Performs a HTTP GET request on the given URL and then reads the reply 
using <A NAME="idx:httpreaddata3:11"></A><A class="pred" href="#http_read_data/3">http_read_data/3</A>. 
Defined options are:

<DL>
<DT><STRONG>connection</STRONG>(<VAR>ConnectionType</VAR>)</DT>
<DD class="defbody">
If <CODE>close</CODE> (default) a new connection is created for this 
request and closed after the request has completed. If <CODE>'Keep-Alive'</CODE> 
the library checks for an open connection on the requested host and port 
and re-uses this connection. The connection is left open if the other 
party confirms the keep-alive and closed otherwise.</DD>
<DT><STRONG>http_version</STRONG>(<VAR>Major-Minor</VAR>)</DT>
<DD class="defbody">
Indicate the HTTP protocol version used for the connection. Default is
<CODE>1.1</CODE>.</DD>
<DT><STRONG>proxy</STRONG>(<VAR>+Host, +Port</VAR>)</DT>
<DD class="defbody">
Use an HTTP proxy to connect to the outside world.</DD>
<DT><STRONG>timeout</STRONG>(<VAR>+Timeout</VAR>)</DT>
<DD class="defbody">
If provided, set a timeout on the stream using <A NAME="idx:setstream2:12"></A><SPAN class="pred-ext">set_stream/2</SPAN>. 
With this option if no new data arrives within <VAR>Timeout</VAR> 
seconds the stream raises an exception. Default is to wait forever (<CODE>infinite</CODE>).</DD>
<DT><STRONG>user_agent</STRONG>(<VAR>+Agent</VAR>)</DT>
<DD class="defbody">
Defines the value of the <CODE>User-Agent</CODE> field of the HTTP 
header. Default is <CODE>SWI-Prolog (http://www.swi-prolog.org)</CODE>.</DD>
<DT><STRONG>request_header</STRONG>(<VAR>Name = Value</VAR>)</DT>
<DD class="defbody">
Add a line "<VAR>Name</VAR>: <VAR>Value</VAR>" to the HTTP request 
header. Both name and value are added uninspected and literally to the 
request header. This may be used to specify accept encodings, languages, 
etc. Please check the RFC2616 (HTTP) document for available fields and 
their meaning.</DD>
<DT><STRONG>reply_header</STRONG>(<VAR>Header</VAR>)</DT>
<DD class="defbody">
Unify <VAR>Header</VAR> with a list of <VAR>Name</VAR>=<VAR>Value</VAR> 
pairs expressing all header fields of the reply. See <A NAME="idx:httpreadrequest2:13"></A><A class="pred" href="#http_read_request/2">http_read_request/2</A> 
for the result format.
</DD>
</DL>

<P>Remaining options are passed to <A NAME="idx:httpreaddata3:14"></A><A class="pred" href="#http_read_data/3">http_read_data/3</A>.</DD>
<DT class="pubdef"><A NAME="http_post/4"><STRONG>http_post</STRONG>(<VAR>+URL, 
+In, -Reply, +Options</VAR>)</A></DT>
<DD class="defbody">
Performs a HTTP POST request on the given URL. It is equivalent to
<A NAME="idx:httpget3:15"></A><A class="pred" href="#http_get/3">http_get/3</A>, 
except for providing an <EM>input document</EM>, which is posted using <A NAME="idx:httppostdata3:16"></A><A class="pred" href="#http_post_data/3">http_post_data/3</A>.</DD>
<DT class="pubdef"><A NAME="http_read_data/3"><STRONG>http_read_data</STRONG>(<VAR>+Header, 
-Data, +Options</VAR>)</A></DT>
<DD class="defbody">
Read data from an HTTP stream. Normally called from <A NAME="idx:httpget3:17"></A><A class="pred" href="#http_get/3">http_get/3</A> 
or
<A NAME="idx:httppost4:18"></A><A class="pred" href="#http_post/4">http_post/4</A>. 
When dealing with HTTP POST in a server this predicate can be used to 
retrieve the posted data. <VAR>Header</VAR> is the parsed header.
<VAR>Options</VAR> is a list of <CODE><VAR>Name</VAR>(Value)</CODE> 
pairs to guide the translation of the data. The following options are 
supported:

<DL>
<DT><STRONG>to</STRONG>(<VAR>Target</VAR>)</DT>
<DD class="defbody">
Do not try to interpret the data according to the MIME-type, but return 
it literally according to <VAR>Target</VAR>, which is one of:

<DL>
<DT><STRONG>stream</STRONG>(<VAR>Output</VAR>)</DT>
<DD class="defbody">
Append the data to the given stream, which must be a Prolog stream open 
for writing. This can be used to save the data in a (memory-)file, XPCE 
object, forward it to process using a pipe, etc.</DD>
<DT><STRONG>atom</STRONG></DT>
<DD class="defbody">
Return the result as an atom. Though SWI-Prolog has no limit on the size 
of atoms and provides atom-garbage collection, this options should be 
used with care.<SUP class="fn">1<SPAN class="fn-text">Currently 
atom-garbage collection is activated after the creation of 10,000 atoms.</SPAN></SUP></DD>
<DT><STRONG>codes</STRONG></DT>
<DD class="defbody">
Return the page as a list of character-codes. This is especially useful 
for parsing it using grammar rules.
</DD>
</DL>

</DD>
<DT><STRONG>content_type</STRONG>(<VAR>Type</VAR>)</DT>
<DD class="defbody">
Overrule the <CODE>Content-Type</CODE> as provided by the HTTP reply 
header. Intended as a work-around for badly configured servers.
</DD>
</DL>

<P>If no <CODE>to(Target)</CODE> option is provided the library tries 
the registered plug-in conversion filters. If none of these succeed it 
tries the built-in content-type handlers or returns the content as an 
atom. The builtin content filters are described below. The provided 
plug-ins are described in the following sections.

<DL>
<DT><STRONG>application/x-www-form-urlencoded</STRONG></DT>
<DD class="defbody">
This is the default encoding mechanism for POST requests issued by a 
web-browser. It is broken down to a list of <VAR>Name</VAR> = <VAR>Value</VAR> 
terms.
</DD>
</DL>

<P>Finally, if all else fails the content is returned as an atom.</DD>
<DT class="pubdef"><A NAME="http_post_data/3"><STRONG>http_post_data</STRONG>(<VAR>+Data, 
+Stream, +ExtraHeader</VAR>)</A></DT>
<DD class="defbody">
Write an HTTP POST request to <VAR>Stream</VAR> using data from <VAR>Data</VAR> 
and passing the additional extra headers from <VAR>ExtraHeader</VAR>.
<VAR>Data</VAR> is one of:

<DL>
<DT><STRONG>html</STRONG>(<VAR>+HTMLTokens</VAR>)</DT>
<DD class="defbody">
Send an HTML token string as produced by the library <CODE>library(html_write)</CODE> 
described in section <A class="sec" href="#sec:3.12">section 3.12</A>.</DD>
<DT><STRONG>file</STRONG>(<VAR>+File</VAR>)</DT>
<DD class="defbody">
Send the contents of <VAR>File</VAR>. The MIME type is derived from the 
filename extension using <A NAME="idx:filemimetype2:19"></A><SPAN class="pred-ext">file_mime_type/2</SPAN>.</DD>
<DT><STRONG>file</STRONG>(<VAR>+Type, +File</VAR>)</DT>
<DD class="defbody">
Send the contents of <VAR>File</VAR> using the provided MIME type, i.e. claiming 
the <CODE>Content-type</CODE> equals <VAR>Type</VAR>.</DD>
<DT><STRONG>codes</STRONG>(<VAR>+Codes</VAR>)</DT>
<DD class="defbody">
Same as string(text/plain, Codes).</DD>
<DT><STRONG>codes</STRONG>(<VAR>+Type, +Codes</VAR>)</DT>
<DD class="defbody">
Send string (list of character codes) using the indicated MIME-type.</DD>
<DT><STRONG>cgi_stream</STRONG>(<VAR>+Stream, +Len</VAR>)</DT>
<DD class="defbody">
Read the input from <VAR>Stream</VAR> which, like CGI data starts with a 
partial HTTP header. The fields of this header are merged with the 
provided <VAR>ExtraHeader</VAR> fields. The first <VAR>Len</VAR> 
characters of <VAR>Stream</VAR> are used.</DD>
<DT><STRONG>form</STRONG>(<VAR>+ListOfParameter</VAR>)</DT>
<DD class="defbody">
Send data of the MIME type <CODE>application/x-www-form-urlencoded</CODE> 
as produced by browsers issuing a POST request from an HTML form.
<VAR>ListOfParameter</VAR> is a list of <VAR>Name</VAR>=<VAR>Value</VAR> 
or
<VAR>Name</VAR>(<VAR>Value</VAR>) .</DD>
<DT><STRONG>form_data</STRONG>(<VAR>+ListOfData</VAR>)</DT>
<DD class="defbody">
Send data of the MIME type <CODE>multipart/form-data</CODE> as produced 
by browsers issuing a POST request from an HTML form using <CODE>enctype</CODE>
<CODE>multipart/form-data</CODE>. This is a somewhat simplified MIME
<CODE>multipart/mixed</CODE> encoding used by browser forms including 
file input fields. <VAR>ListOfData</VAR> is the same as for the <VAR>List</VAR> 
alternative described below. Below is an example from the SWI-Prolog
<A class="url" href="http://www.openrdf.org">Sesame</A> interface. <VAR>Repository</VAR>, 
etc. are atoms providing the value, while the last argument provides a 
value from a file.

<PRE class="code">
        ...,
        http_post([ protocol(http),
                    host(Host),
                    port(Port),
                    path(ActionPath)
                  ],
                  form_data([ repository = Repository,
                              dataFormat = DataFormat,
                              baseURI    = BaseURI,
                              verifyData = Verify,
                              data       = file(File)
                            ]),
                  _Reply,
                  []),
        ...,
</PRE>

</DD>
<DT><STRONG>List</STRONG></DT>
<DD class="defbody">
If the argument is a plain list, it is sent using the MIME type
<CODE>multipart/mixed</CODE> and packed using <A NAME="idx:mimepack3:20"></A><SPAN class="pred-ext">mime_pack/3</SPAN>. 
See
<A NAME="idx:mimepack3:21"></A><SPAN class="pred-ext">mime_pack/3</SPAN> 
for details on the argument format.
</DD>
</DL>

</DD>
</DL>

<H4><A NAME="sec:2.2.1"><SPAN class="sec-nr">2.2.1</SPAN> <SPAN class="sec-title">The 
MIME client plug-in</SPAN></A></H4>

<A NAME="sec:httpmimeplugin"></A>

<P>This plug-in library <CODE>library(http/http_mime_plugin)</CODE> 
breaks multipart documents that are recognised by the <CODE>Content-Type: 
multipart/form-data</CODE> or <CODE>Mime-Version: 1.0</CODE> in the 
header into a list of <VAR>Name</VAR> = <VAR>Value</VAR> pairs. This 
library deals with data from web-forms using the <CODE>multipart/form-data</CODE> 
encoding as well as the <A class="url" href="http://www.fipa.org">FIPA</A> 
agent-protocol messages.

<H4><A NAME="sec:2.2.2"><SPAN class="sec-nr">2.2.2</SPAN> <SPAN class="sec-title">The 
SGML client plug-in</SPAN></A></H4>

<A NAME="sec:httpsgmlplugin"></A>

<P>This plug-in library <CODE>library(http/http_sgml_plugin)</CODE> 
provides a bridge between the SGML/XML/HTML parser provided by <CODE>library(sgml)</CODE> 
and the http client library. After loading this hook the following 
mime-types are automatically handled by the SGML parser.

<DL>
<DT><STRONG>text/html</STRONG></DT>
<DD class="defbody">
Handed to <CODE>library(sgml)</CODE> using W3C HTML 4.0 DTD, suppressing 
and ignoring all HTML syntax errors. <VAR>Options</VAR> is passed to
<A NAME="idx:loadstructure3:22"></A><SPAN class="pred-ext">load_structure/3</SPAN>.</DD>
<DT><STRONG>text/xml</STRONG></DT>
<DD class="defbody">
Handed to <CODE>library(sgml)</CODE> using dialect <CODE>xmlns</CODE> 
(XML + namespaces).
<VAR>Options</VAR> is passed to <A NAME="idx:loadstructure3:23"></A><SPAN class="pred-ext">load_structure/3</SPAN>. 
In particular,
<CODE>dialect(xml)</CODE> may be used to suppress namespace handling.</DD>
<DT><STRONG>text/x-sgml</STRONG></DT>
<DD class="defbody">
Handled to <CODE>library(sgml)</CODE> using dialect <CODE>sgml</CODE>. <VAR>Options</VAR> 
is passed to <A NAME="idx:loadstructure3:24"></A><SPAN class="pred-ext">load_structure/3</SPAN>.
</DD>
</DL>

<H2><A NAME="sec:3"><SPAN class="sec-nr">3</SPAN> <SPAN class="sec-title">The 
HTTP server libraries</SPAN></A></H2>

<A NAME="sec:httpserver"></A>

<P>The HTTP server library consists of two parts obligatory and one 
optional part. The first deals with connection management and has three 
different implementation depending on the desired type of server. The 
second implements a generic wrapper for decoding the HTTP request, 
calling user code to handle the request and encode the answer. The 
optional <CODE>http_dispatch</CODE> module can be used to assign HTTP
<EM>locations</EM> (paths) to predicates. This design is summarised in
<A class="fig" href="#fig:httpserver">figure 1</A>.

<P><A NAME="fig:httpserver"></A>
<CENTER>
<IMG SRC="httpserver.gif">
</CENTER>
<TABLE ALIGN=center WIDTH="75%"><TR><TD>
<B>Figure 1 : </B>Design of the HTTP server</TABLE>

<P>The functional body of the user's code is independent from the 
selected server-type, making it easy to switch between the supported 
server types.

<H3><A NAME="sec:3.1"><SPAN class="sec-nr">3.1</SPAN> <SPAN class="sec-title">The 
`Body'</SPAN></A></H3>

<A NAME="sec:body"></A>

<P>The server-body is the code that handles the request and formulates a 
reply. To facilitate all mentioned setups, the body is driven by
<A NAME="idx:httpwrapper5:25"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A>. 
The goal is called with the parsed request (see
<A class="sec" href="#sec:3.6">section 3.6</A>) as argument and <CODE>current_output</CODE> 
set to a temporary buffer. Its task is closely related to the task of a 
CGI script; it must write a header declaring holding at least the
<CODE>Content-type</CODE> field and a body. Here is a simple body 
writing the request as an HTML table.

<PRE class="code">
reply(Request) :-
        format('Content-type: text/html~n~n', []),
        format('&lt;html&gt;~n', []),
        format('&lt;table border=1&gt;~n'),
        print_request(Request),
        format('~n&lt;/table&gt;~n'),
        format('&lt;/html&gt;~n', []).

print_request([]).
print_request([H|T]) :-
        H =.. [Name, Value],
        format('&lt;tr&gt;&lt;td&gt;~w&lt;td&gt;~w~n', [Name, Value]),
        print_request(T).
</PRE>

<P>The infrastructure recognises the header
<TT>Transfer-encoding:&nbsp;chunked</TT>, causing it to use chunked 
encoding if the client allows for it. See also <A class="sec" href="#sec:4">section 
4</A> and the
<CODE>chunked</CODE> option in <A NAME="idx:httphandler3:26"></A><A class="pred" href="#http_handler/3">http_handler/3</A>. 
Other header lines are passed verbatim to the client. Typical examples 
are <TT>Set-Cookie</TT> and authentication headers (see <A class="sec" href="#sec:3.4">section 
3.4</A>.

<H4><A NAME="sec:3.1.1"><SPAN class="sec-nr">3.1.1</SPAN> <SPAN class="sec-title">Returning 
special status codes</SPAN></A></H4>

<A NAME="sec:httpspecials"></A>

<P>Besides returning a page by writing it to the current output stream, 
the server goal can raise an exception using <A NAME="idx:throw1:27"></A><SPAN class="pred-ext">throw/1</SPAN> 
to generate special pages such as <CODE>not_found</CODE>, <CODE>moved</CODE>, 
etc. The defined exceptions are:

<DL>
<DT><STRONG>http_reply</STRONG>(<VAR>+Reply, +HdrExtra</VAR>)</DT>
<DD class="defbody">
Return a result page using <A NAME="idx:httpreply3:28"></A><A class="pred" href="#http_reply/3">http_reply/3</A>. 
See <A NAME="idx:httpreply3:29"></A><A class="pred" href="#http_reply/3">http_reply/3</A> 
for details.</DD>
<DT><STRONG>http_reply</STRONG>(<VAR>+Reply</VAR>)</DT>
<DD class="defbody">
Equivalent to <CODE>http_reply(Reply,[])</CODE>.</DD>
<DT><STRONG>http</STRONG>(<VAR>not_modified</VAR>)</DT>
<DD class="defbody">
Equivalent to <CODE>http_reply(not_modified,[])</CODE>. This exception 
is for backward compatibility and can be used by the server to indicate 
the referenced resource has not been modified since it was requested 
last time.
</DD>
</DL>

<H3><A NAME="sec:3.2"><SPAN class="sec-nr">3.2</SPAN> <SPAN class="sec-title">Dispatching 
HTTP locations over predicates</SPAN></A></H3>

<A NAME="sec:dispatch"></A>

<P>The library <CODE>http/http_dispatch.pl</CODE> can be between <A NAME="idx:httpwrapper5:30"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A> 
and the user handlers as described in <A class="sec" href="#sec:3.1">section 
3.1</A> to distribute locations over multiple predicates. This has 
several advantages:

<P>
<UL>
<LI>It makes a distinction between failure of the predicate and 
undefined locations, giving a server error on failure and a 404 
existence error on undefined locations.

<P>
<LI>It is much easier to put a spy-point on specific locations or find 
the code implementing a location. In addition, the
<A NAME="idx:edit1:31"></A><SPAN class="pred-ext">edit/1</SPAN> 
interface is extended to deal with locations. This allows for <CODE>?- edit('/path1/path2').</CODE> 
to open an editor on the implementation of the HTTP location <CODE>/path1/path2</CODE>.
</UL>

<P>We introduce the library with a small but complete example combining 
the core HTTP libraries. To test the example on port 5000, load the 
code, run <CODE>?- server(5000).</CODE> and direct your browser to
<A class="url" href="http://localhost:5000">http://localhost:5000</A>.

<PRE class="code">
:- use_module(library('http/thread_httpd')).
:- use_module(library('http/http_dispatch')).
:- use_module(library('http/html_write')).

server(Port) :-
        http_server(http_dispatch, [port(Port)]).

:- http_handler('/', root, []).
:- http_handler('/hello/world', hello_world, []).

root(_Request) :-
        reply_html_page([ title('Demo server')
                        ],
                        [ p(a(href('hello/world'), hello))
                        ]).

hello_world(_Request) :-
        reply_html_page([ title('Hello World')
                        ],
                        [ h1('Hello World'),
                          p('This is my first page')
                        ]).
</PRE>

<DL>
<DT class="pubdef"><A NAME="http_dispatch/1"><STRONG>http_dispatch</STRONG>(<VAR>+Request</VAR>)</A></DT>
<DD class="defbody">
Dispatch <VAR>Request</VAR> to a predicate defined to handle the path 
component (location) of the request. Locations are declared using
<A NAME="idx:httphandler3:32"></A><A class="pred" href="#http_handler/3">http_handler/3</A>. 
The predicate <A NAME="idx:httpdispatch1:33"></A><A class="pred" href="#http_dispatch/1">http_dispatch/1</A> 
is normally called from <A NAME="idx:httpserver2:34"></A><A class="pred" href="#http_server/2">http_server/2</A>.</DD>
<DT class="pubdef"><A NAME="http_handler/3"><STRONG>http_handler</STRONG>(<VAR>+Location, 
:Closure, +Options</VAR>)</A></DT>
<DD class="defbody">
Call <CODE>call(Closure, Request)</CODE> if an HTTP request for the path
<VAR>Location</VAR> is dispatched by <A NAME="idx:httpdispatch1:35"></A><A class="pred" href="#http_dispatch/1">http_dispatch/1</A>. 
Options include:

<DL>
<DT><STRONG>authentication</STRONG>(<VAR>+Type</VAR>)</DT>
<DD class="defbody">
Demand authentication. Authentication methods define <VAR>Type</VAR> and 
are pluggable. The library <CODE>http_authenticate.pl</CODE> provides a 
plugin for user/password based <CODE>Basic</CODE> HTTP authentication.</DD>
<DT><STRONG>chunked</STRONG></DT>
<DD class="defbody">
Enable chunked transfer-encoding if the client allows for it. See
<A class="sec" href="#sec:4">section 4</A>.</DD>
<DT><STRONG>id</STRONG>(<VAR>+ID</VAR>)</DT>
<DD class="defbody">
Identifier of the handler. The default identifier is the predicate name. 
Used by <A NAME="idx:httplocationbyid2:36"></A><A class="pred" href="#http_location_by_id/2">http_location_by_id/2</A>.</DD>
<DT><STRONG>time_limit</STRONG>(<VAR>+Spec</VAR>)</DT>
<DD class="defbody">
Specify a (wall-)time limit to handle the request. <VAR>Spec</VAR> is 
one of
<CODE>infinite</CODE>, <CODE>default</CODE> or a number expressing 
seconds. If
<CODE>default</CODE> or omitted, the setting (see <A NAME="idx:setting4:37"></A><SPAN class="pred-ext">setting/4</SPAN>)
<CODE>http:time_limit</CODE> is used.</DD>
<DT><STRONG>prefix</STRONG></DT>
<DD class="defbody">
If present, call handler for all paths that <EM>start with</EM> the 
given path. If multiple specifications match the most specific one is 
used.</DD>
<DT><STRONG>priority</STRONG>(<VAR>+Integer</VAR>)</DT>
<DD class="defbody">
If two handlers handle the same path, the one with the highest priority 
is used. If equal, the last registered is used. Please be aware that the 
order of clauses in multifile predicates can change due to reloading 
files.</DD>
<DT><STRONG>spawn</STRONG>(<VAR>+Spec</VAR>)</DT>
<DD class="defbody">
Handle the request on a seperate thread. <VAR>Spec</VAR> is either the 
name of a thread pool (see <A NAME="idx:threadpoolcreate3:38"></A><SPAN class="pred-ext">thread_pool_create/3</SPAN> 
from library(thread_pool) or a set of options that are passed to <A NAME="idx:threadcreate3:39"></A><SPAN class="pred-ext">thread_create/3</SPAN>. 
See also
<A NAME="idx:httpspawn2:40"></A><A class="pred" href="#http_spawn/2">http_spawn/2</A>.
</DD>
</DL>

<P>Note that <A NAME="idx:httphandler3:41"></A><A class="pred" href="#http_handler/3">http_handler/3</A> 
is normally invoked as a directive and processed using term-expansion. 
Using term-expansion ensures proper update through <A NAME="idx:make0:42"></A><SPAN class="pred-ext">make/0</SPAN> 
when the specification is modified. We do not expand when the 
cross-referencer is running to ensure proper handling of the meta-call.</DD>
<DT class="pubdef"><A NAME="http_delete_handler/1"><STRONG>http_delete_handler</STRONG>(<VAR>+Path</VAR>)</A></DT>
<DD class="defbody">
Delete handler for <VAR>Path</VAR>. Typically, this should only be used 
for handlers that are registered dynamically. Use the priority option to 
overrule an existing handler.</DD>
<DT class="pubdef"><A NAME="http_location_by_id/2"><STRONG>http_location_by_id</STRONG>(<VAR>+ID, 
-Location</VAR>)</A></DT>
<DD class="defbody">
Find the HTTP Location of handler with ID. If the setting (see
<A NAME="idx:setting2:43"></A><SPAN class="pred-ext">setting/2</SPAN>) 
http:prefix is active, Location is the handler location prefixed with 
the prefix setting. Handler IDs can be specified in two ways:

<P>
<UL>
<LI><I><CODE>id(ID)</CODE></I><BR>
If this appears in the option list of the handler, this it is used and 
takes preference over using the predicate.

<P>
<LI><I>&lt;<VAR>module</VAR>&gt;:&lt;<VAR>predicate</VAR>&gt;</I><BR>
The module-qualified name of the predicate.

<P>
<LI><I>&lt;<VAR>predicate</VAR>&gt;</I><BR>
</UL>
</DD>
<DT class="pubdef"><A NAME="http_current_handler/2"><STRONG>http_current_handler</STRONG>(<VAR>?Location, 
?Closure</VAR>)</A></DT>
<DD class="defbody">
True if <VAR>Location</VAR> is handled by <VAR>Closure</VAR>. It <VAR>Location</VAR> 
is given, the <VAR>Closure</VAR> with highest priority is returned.</DD>
<DT class="pubdef"><A NAME="http_reply_file/3"><STRONG>http_reply_file</STRONG>(<VAR>+FileSpec, 
+Options, +Request</VAR>)</A></DT>
<DD class="defbody">
Reply a file. The argument order is defined to allow using the predicate 
as a closure for <A NAME="idx:httphandler3:44"></A><A class="pred" href="#http_handler/3">http_handler/3</A>. 
Options include:

<DL>
<DT><STRONG>cache</STRONG>(<VAR>+Boolean</VAR>)</DT>
<DD class="defbody">
If <CODE>true</CODE> (default), handle If-modified-since and send 
modification time.
</DD>
<DT><STRONG>mime_type</STRONG>(<VAR>+Type</VAR>)</DT>
<DD class="defbody">
Overrule mime-type guessing from the filename as provided by 
file_mime_type/
</DD>
</DL>

<P>Below is an example. Note that the file argument can be a 
specification for <A NAME="idx:absolutefilename3:45"></A><SPAN class="pred-ext">absolute_file_name/3</SPAN> 
that is searched over application libraries defined using <A NAME="idx:filesearchpath2:46"></A><SPAN class="pred-ext">file_search_path/2</SPAN>.

<PRE class="code">
:- http_handler('/css/myapp.css',
                http_reply_file('myapp.css', []),
                []).
</PRE>

<P></DD>
</DL>

<H3><A NAME="sec:3.3"><SPAN class="sec-nr">3.3</SPAN> <SPAN class="sec-title">HTTP 
Session management</SPAN></A></H3>

<A NAME="sec:session"></A>

<P>The library <CODE>library(http/http_session.pl)</CODE> provides 
cookie-based session management. The library installs a session-id 
cookie using the hook http:request_expansion/2. It allows querying the 
session and provides a simple assert/retract based store to store 
information related to a session. Note that session management only 
works with the threaded and XPCE based server frameworks as the inetd 
based server starts a server for each request.

<P>The examples contain the file <CODE>calc.pl</CODE>, which realises a 
simple calculator with internal state.

<DL>
<DT class="pubdef"><A NAME="http_set_session_options/1"><STRONG>http_set_session_options</STRONG>(<VAR>+Options</VAR>)</A></DT>
<DD class="defbody">
Set options for the session manager. Defined options are:

<DL>
<DT><STRONG>timeout</STRONG>(<VAR>+Seconds</VAR>)</DT>
<DD class="defbody">
Max idle time of a session. Session cookies are deleted if no request is 
received within the specified time. The value `0' disables timeout 
handling.
</DD>
<DT><STRONG>cookie</STRONG>(<VAR>+Atom</VAR>)</DT>
<DD class="defbody">
Name of the cookie to use for session management. The default is
<CODE>swipl_session</CODE>.
</DD>
<DT><STRONG>path</STRONG>(<VAR>+Atom</VAR>)</DT>
<DD class="defbody">
Path with which to associate the session management. Default is
<CODE>/</CODE>, associating it with the entire server.
</DD>
</DL>

</DD>
<DT class="pubdef"><A NAME="http_session_id/1"><STRONG>http_session_id</STRONG>(<VAR>-Id</VAR>)</A></DT>
<DD class="defbody">
Returns an identifier for the current session. The identifier is an 
atom.</DD>
<DT class="pubdef"><A NAME="http_current_session/2"><STRONG>http_current_session</STRONG>(<VAR>?Id, 
?Data</VAR>)</A></DT>
<DD class="defbody">
Enumerate sessions and associated data. All sessions have the
<VAR>Data</VAR> item <CODE>idle(Seconds)</CODE>, describing the current 
idle-time of the session. Other data elements are added by the user 
using
<A NAME="idx:httpsessionassert1:47"></A><A class="pred" href="#http_session_assert/1">http_session_assert/1</A> 
and friends.</DD>
<DT class="pubdef"><A NAME="http_session_asserta/1"><STRONG>http_session_asserta</STRONG>(<VAR>+Term</VAR>)</A></DT>
<DD class="defbody">
Associate <VAR>Term</VAR> with the current session, before any other 
associated term.</DD>
<DT class="pubdef"><A NAME="http_session_assert/1"><STRONG>http_session_assert</STRONG>(<VAR>+Term</VAR>)</A></DT>
<DD class="defbody">
Associate <VAR>Term</VAR> with the current session, after any other 
associated term.</DD>
<DT class="pubdef"><A NAME="http_session_retract/1"><STRONG>http_session_retract</STRONG>(<VAR>?Term</VAR>)</A></DT>
<DD class="defbody">
Non-deterministically retract terms associated with the current session.</DD>
<DT class="pubdef"><A NAME="http_session_retractall/1"><STRONG>http_session_retractall</STRONG>(<VAR>+Term</VAR>)</A></DT>
<DD class="defbody">
Retract all matching terms from associated with the current session.</DD>
<DT class="pubdef"><A NAME="http_session_data/1"><STRONG>http_session_data</STRONG>(<VAR>?Term</VAR>)</A></DT>
<DD class="defbody">
Enumerate all associated terms that unify with <VAR>Term</VAR>.
</DD>
</DL>

<H3><A NAME="sec:3.4"><SPAN class="sec-nr">3.4</SPAN> <SPAN class="sec-title">HTTP 
Authentication</SPAN></A></H3>

<A NAME="sec:auth"></A>

<P>The module <CODE>http/http_authenticate</CODE> provides the basics to 
validate an HTTP <CODE>Authorization</CODE> error. User and password 
information are read from a Unix/Apache compatible password file. This 
information, as well as the validation process is cached to achieve 
optimal performance.

<DL>
<DT class="pubdef"><A NAME="http_authenticate/+Type, +Request, -User"><STRONG>http_authenticate</STRONG>(<VAR>+Type, 
+Request, -User</VAR>)</A></DT>
<DD class="defbody">
rue if Request contains the information to continue according to Type. 
Type identifies the required authentication technique:

<DL>
<DT><STRONG>basic</STRONG>(<VAR>+PasswordFile</VAR>)</DT>
<DD class="defbody">
Use HTTP <CODE>Basic</CODE> authentication and verify the password from 
PasswordFile. PasswordFile is a file holding usernames and passwords in 
a format compatible to Unix and Apache. Each line is record with <CODE>:</CODE> 
separated fields. The first field is the username and the second the 
password _hash_. Password hashes are validated using <A NAME="idx:crypt2:48"></A><SPAN class="pred-ext">crypt/2</SPAN>.
</DD>
</DL>

<P>Successful authorization is cached for 60 seconds to avoid overhead 
of decoding and lookup of the user and password data.

<P><A NAME="idx:httpauthenticate3:49"></A><SPAN class="pred-ext">http_authenticate/3</SPAN> 
just validates the header. If authorization is not provided the browser 
must be challenged, in response to which it normally opens a 
user-password dialogue. Example code realising this is below. The 
exception causes the HTTP wrapper code to generate an HTTP 401 reply.

<PRE class="code">
    ...,
    (   http_authenticate(basic(passwd), Request, User)
    -&gt;  true
    ;   throw(http_reply(authorise(basic, Realm)))
    ).
</PRE>

<P>Alternatively <CODE>basic(+PasswordFile)</CODE> can be passed as an 
option to
<A NAME="idx:httphandler3:50"></A><A class="pred" href="#http_handler/3">http_handler/3</A>.
</DD>
</DL>

<H3><A NAME="sec:3.5"><SPAN class="sec-nr">3.5</SPAN> <SPAN class="sec-title">Get 
parameters from HTML forms</SPAN></A></H3>

<A NAME="sec:httpparam"></A>

<P>The library <CODE>library(http/http_parameters)</CODE> provides two 
predicates to fetch HTTP request parameters as a type-checked list 
easily. The library transparently handles both GET and POST requests. It 
builds on top of the low-level request representation described in
<A class="sec" href="#sec:3.6">section 3.6</A>.

<DL>
<DT class="pubdef"><A NAME="http_parameters/2"><STRONG>http_parameters</STRONG>(<VAR>+Request, 
?Parameters</VAR>)</A></DT>
<DD class="defbody">
The predicate is passes the <VAR>Request</VAR> as provided to the 
handler goal by <A NAME="idx:httpwrapper5:51"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A> 
as well as a partially instantiated lists describing the requested 
parameters and their types. Each parameter specification in <VAR>Parameters</VAR> 
is a term of the format
<VAR>Name</VAR>(<VAR>-Value</VAR>, <VAR>+Options</VAR>) . <VAR>Options</VAR> 
is a list of option terms describing the type, default, etc. If no 
options are specified the parameter must be present and its value is 
returned in
<VAR>Value</VAR> as an atom. If a parameter is missing the exception
<CODE>error(<CODE>existence_error(form_data, Name)</CODE>, _)</CODE> is 
thrown. Defined options are:

<DL>
<DT><STRONG>default</STRONG>(<VAR>Default</VAR>)</DT>
<DD class="defbody">
If the named parameter is missing, <VAR>Value</VAR> is unified to
<VAR>Default</VAR>.</DD>
<DT><STRONG>optional</STRONG>(<VAR>true</VAR>)</DT>
<DD class="defbody">
If the named parameter is missing, <VAR>Value</VAR> is left unbound and 
no error is generated.</DD>
<DT><STRONG>zero_or_more</STRONG></DT>
<DD class="defbody">
The same parameter may not appear or appear multiple times. If this 
option is present, <CODE>default</CODE> and <CODE>optional</CODE> are 
ignored and the value is returned as a list. Type checking options are 
processed on each value.</DD>
<DT><STRONG>oneof</STRONG>(<VAR>List</VAR>)</DT>
<DD class="defbody">
Succeeds if the value is member of the given list.</DD>
<DT><B>length <VAR>&gt; N</VAR></B></DT>
<DD class="defbody">
Succeeds if value is an atom of more than <VAR>N</VAR> characters.</DD>
<DT><B>length <VAR>&gt;= N</VAR></B></DT>
<DD class="defbody">
Succeeds if value is an atom of more or than equal to <VAR>N</VAR> 
characters.</DD>
<DT><B>length <VAR>&lt; N</VAR></B></DT>
<DD class="defbody">
Succeeds if value is an atom of less than <VAR>N</VAR> characters.</DD>
<DT><B>length <VAR>=&lt; N</VAR></B></DT>
<DD class="defbody">
Succeeds if value is an atom of length than or equal to <VAR>N</VAR> 
characters.</DD>
<DT><STRONG>number</STRONG></DT>
<DD class="defbody">
Convert value to a number. Throws a type-error otherwise.</DD>
<DT><STRONG>integer</STRONG></DT>
<DD class="defbody">
Convert value to an integer. Throws a type-error otherwise.</DD>
<DT><STRONG>float</STRONG></DT>
<DD class="defbody">
Convert value to a float. Integers are transformed into float. Throws a 
type-error otherwise.</DD>
<DT><STRONG>between</STRONG>(<VAR>+Low, +High</VAR>)</DT>
<DD class="defbody">
Convert value to a number and if either <VAR>Low</VAR> or <VAR>High</VAR> 
is a float, force value to be a float. Then check that the value is in 
the given range, which includes the boundaries.
</DD>
</DL>

<P>Below is an example

<PRE class="code">
reply(Request) :-
        http_parameters(Request,
                        [ title(Title, [optional(true)]),
                          name(Name, [ length &gt;= 2 ]),
                          age(Age, [integer])
                        ]),
        ...
</PRE>

<P>Same as <CODE>http_parameters(Request, Parameters,[])</CODE></DD>
<DT class="pubdef"><A NAME="http_parameters/3"><STRONG>http_parameters</STRONG>(<VAR>+Request, 
?Parameters, +Options</VAR>)</A></DT>
<DD class="defbody">
In addition to <A NAME="idx:httpparameters2:52"></A><A class="pred" href="#http_parameters/2">http_parameters/2</A>, 
the following options are defined.

<DL>
<DT><STRONG>form_data</STRONG>(<VAR>-Data</VAR>)</DT>
<DD class="defbody">
Return the entire set of provided <VAR>Name</VAR>=<VAR>Value</VAR> pairs 
from the GET or POST request. All values are returned as atoms.</DD>
<DT><STRONG>attribute_declarations</STRONG>(<VAR>:Goal</VAR>)</DT>
<DD class="defbody">
If a parameter specification lacks the parameter options, call
<CODE>call(Goal, +ParamName, -Options)</CODE> to find the options. 
Intended to share declarations over many calls to <A NAME="idx:httpparameters3:53"></A><A class="pred" href="#http_parameters/3">http_parameters/3</A>. 
Using this construct the above can be written as below.

<PRE class="code">
reply(Request) :-
        http_parameters(Request,
                        [ title(Title),
                          name(Name),
                          age(Age)
                        ],
                        [ attribute_declarations(param)
                        ]),
        ...

param(title, [optional(true)]).
param(name,  [length &gt;= 2 ]).
param(age,   [integer]).
</PRE>

<P></DD>
</DL>

</DD>
</DL>

<H3><A NAME="sec:3.6"><SPAN class="sec-nr">3.6</SPAN> <SPAN class="sec-title">Request 
format</SPAN></A></H3>

<A NAME="sec:request"></A>

<P>The body-code (see <A class="sec" href="#sec:3.1">section 3.1</A>) is 
driven by a <VAR>Request</VAR>. This request is generated from <A NAME="idx:httpreadrequest2:54"></A><A class="pred" href="#http_read_request/2">http_read_request/2</A> 
defined in
<CODE>library(http/http_header)</CODE>.

<DL>
<DT class="pubdef"><A NAME="http_read_request/2"><STRONG>http_read_request</STRONG>(<VAR>+Stream, 
-Request</VAR>)</A></DT>
<DD class="defbody">
Reads an HTTP request from <VAR>Stream</VAR> and unify <VAR>Request</VAR> 
with the parsed request. <VAR>Request</VAR> is a list of <CODE><VAR>Name</VAR>(Value)</CODE> 
elements. It provides a number of predefined elements for the result of 
parsing the first line of the request, followed by the additional 
request parameters. The predefined fields are:

<DL>
<DT><STRONG>host</STRONG>(<VAR>Host</VAR>)</DT>
<DD class="defbody">
If the request contains <CODE>Host: </CODE><VAR>Host</VAR>, Host is 
unified with the host-name. If <VAR>Host</VAR> is of the format &lt;<VAR>host</VAR>&gt;:&lt;<VAR>port</VAR>&gt;
<VAR>Host</VAR> only describes &lt;<VAR>host</VAR>&gt; and a field <CODE>port(Port)</CODE> 
where
<VAR>Port</VAR> is an integer is added.</DD>
<DT><STRONG>input</STRONG>(<VAR>Stream</VAR>)</DT>
<DD class="defbody">
The <VAR>Stream</VAR> is passed along, allowing to read more data or 
requests from the same stream. This field is always present.</DD>
<DT><STRONG>method</STRONG>(<VAR>Method</VAR>)</DT>
<DD class="defbody">
<VAR>Method</VAR> is one of <CODE>get</CODE>, <CODE>put</CODE> or <CODE>post</CODE>. 
This field is present if the header has been parsed successfully.</DD>
<DT><STRONG>path</STRONG>(<VAR>Path</VAR>)</DT>
<DD class="defbody">
Path associated to the request. This field is always present.</DD>
<DT><STRONG>peer</STRONG>(<VAR>Peer</VAR>)</DT>
<DD class="defbody">
<VAR>Peer</VAR> is a term <CODE>ip(A,B,C,D)</CODE> containing the IP 
address of the contacting host.</DD>
<DT><STRONG>port</STRONG>(<VAR>Port</VAR>)</DT>
<DD class="defbody">
Port requested. See <CODE>host</CODE> for details.</DD>
<DT><STRONG>search</STRONG>(<VAR>ListOfNameValue</VAR>)</DT>
<DD class="defbody">
Search-specification of URI. This is the part after the <CODE>?</CODE>, 
normally used to transfer data from HTML forms that use the `<CODE>GET</CODE>' 
protocol. In the URL it consists of a www-form-encoded list of <VAR>Name</VAR>=<VAR>Value</VAR> 
pairs. This is mapped to a list of Prolog <VAR>Name</VAR>=<VAR>Value</VAR> 
terms with decoded names and values. This field is only present if the 
location contains a search-specification.</DD>
<DT><STRONG>http_version</STRONG>(<VAR>Major-Minor</VAR>)</DT>
<DD class="defbody">
If the first line contains the <CODE>HTTP/</CODE><VAR>Major</VAR>.<VAR>Minor</VAR> 
version indicator this element indicate the HTTP version of the peer. 
Otherwise this field is not present.</DD>
<DT><STRONG>cookie</STRONG>(<VAR>ListOfNameValue</VAR>)</DT>
<DD class="defbody">
If the header contains a <CODE>Cookie</CODE> line, the value of the 
cookie is broken down in <VAR>Name</VAR>=<VAR>Value</VAR> pairs, where 
the
<VAR>Name</VAR> is the lowercase version of the cookie name as used for 
the HTTP fields.</DD>
<DT><STRONG>set_cookie</STRONG>(<VAR>set_cookie(Name, Value, Options)</VAR>)</DT>
<DD class="defbody">
If the header contains a <CODE>SetCookie</CODE> line, the cookie field 
is broken down into the <VAR>Name</VAR> of the cookie, the <VAR>Value</VAR> 
and a list of <VAR>Name</VAR>=<VAR>Value</VAR> pairs for additional 
options such as <CODE>expire</CODE>, <CODE>path</CODE>, <CODE>domain</CODE> 
or <CODE>secure</CODE>.
</DD>
</DL>

<P>If the first line of the request is tagged with
<CODE>HTTP/</CODE><VAR>Major</VAR>.<VAR>Minor</VAR>, <A NAME="idx:httpreadrequest2:55"></A><A class="pred" href="#http_read_request/2">http_read_request/2</A> 
reads all input upto the first blank line. This header consists of
<VAR>Name</VAR>:<VAR>Value</VAR> fields. Each such field appears as a 
term
<CODE><VAR>Name</VAR>(Value)</CODE> in the <VAR>Request</VAR>, where <VAR>Name</VAR> 
is canonised for use with Prolog. Canonisation implies that the
<VAR>Name</VAR> is converted to lower case and all occurrences of the
<CODE>-</CODE> are replaced by <CODE>_</CODE>. The value for the
<CODE>Content-length</CODE> fields is translated into an integer.
</DD>
</DL>

<P>Here is an example:

<PRE class="code">
?- http_read_request(user, X).
|: GET /mydb?class=person HTTP/1.0
|: Host: gollem
|: 
X = [ input(user),
      method(get),
      search([ class = person
             ]),
      path('/mydb'),
      http_version(1-0),
      host(gollem)
    ].
</PRE>

<H4><A NAME="sec:3.6.1"><SPAN class="sec-nr">3.6.1</SPAN> <SPAN class="sec-title">Handling 
POST requests</SPAN></A></H4>

<P>Where the HTTP <CODE>GET</CODE> operation is intended to get a 
document, using a <VAR>path</VAR> and possibly some additional search 
information, the <CODE>POST</CODE> operation is intended to hand 
potentially large amounts of data to the server for processing.

<P>The <VAR>Request</VAR> parameter above contains the term <CODE>method(post)</CODE>. 
The data posted is left on the input stream that is available through 
the term <CODE>input(Stream)</CODE> from the <VAR>Request</VAR> header. 
This data can be read using <A NAME="idx:httpreaddata3:56"></A><A class="pred" href="#http_read_data/3">http_read_data/3</A> 
from the HTTP client library. Here is a demo implementation simply 
returning the parsed posted data as plain text (assuming <A NAME="idx:pp1:57"></A><SPAN class="pred-ext">pp/1</SPAN> 
pretty-prints the data).

<PRE class="code">
reply(Request) :-
        member(method(post), Request), !,
        http_read_data(Request, Data, []),
        format('Content-type: text/plain~n~n', []),
        pp(Data).
</PRE>

<P>If the POST is initiated from a browser, content-type is generally 
either <CODE>application/x-www-form-urlencoded</CODE> or
<CODE>multipart/form-data</CODE>. The latter is broken down 
automatically if the plug-in <CODE>library(http/http_mime_plugin)</CODE> 
is loaded.

<H3><A NAME="sec:3.7"><SPAN class="sec-nr">3.7</SPAN> <SPAN class="sec-title">Running 
the server</SPAN></A></H3>

<P>The functionality of the server should be defined in one Prolog file 
(of course this file is allowed to load other files). Depending on the 
wanted server setup this `body' is wrapped into a small Prolog file 
combining the body with the appropriate server interface. There are 
three supported server-setups. For most applications we advice the 
multi-threaded server. Examples of this server architecture are the
<A class="url" href="http://www.swi-prolog.org/packages/pldoc.html">PlDoc</A> 
documentation system and the <A class="url" href="http://www.swi-prolog.org/packages/SeRQL/">SeRQL</A> 
Semantic Web server infrastructure.

<P>All the server setups may be wrapped in a <EM>reverse proxy</EM> to 
make them available from the public web-server as described in
<A class="sec" href="#sec:3.7.7">section 3.7.7</A>.

<P>
<UL>
<LI><I>Using <CODE>library(thread_httpd)</CODE> for a multi-threaded 
server</I><BR>
This server exploits the multi-threaded version of SWI-Prolog, running 
the users body code parallel from a pool of worker threads. As it avoids 
the state engine and copying required in the event-driven server it is 
generally faster and capable to handle multiple requests concurrently.

<P>This server is harder to debug due to the involved threading, 
although the GUI tracer provides reasonable support for multi-threaded 
applications using the <A NAME="idx:tspy1:58"></A><SPAN class="pred-ext">tspy/1</SPAN> 
command. It can provide fast communication to multiple clients and can 
be used for more demanding servers.

<P>
<LI><I>Using <CODE>library(xpce_httpd)</CODE> for an event-driven server</I><BR>
This approach provides a single-threaded event-driven application. The 
clients talk to XPCE sockets that collect an HTTP request. The server 
infra-structure can talk to multiple clients simultaneously, but once a 
request is complete the wrappers call the user's goal and blocks all 
further activity until the request is handled. Requests from multiple 
clients are thus fully serialised in one Prolog process.

<P>This server setup is very suitable for debugging as well as embedded 
server in simple applications in a fairly controlled environment.

<P>
<LI><I>Using <CODE>library(inetd_httpd)</CODE> for server-per-client</I><BR>
In this setup the Unix <B>inetd</B> user-daemon is used to initialise a 
server for each connection. This approach is especially suitable for 
servers that have a limited startup-time. In this setup a crashing 
client does not influence other requests.

<P>This server is very hard to debug as the server is not connected to 
the user environment. It provides a robust implementation for servers 
that can be started quickly.
</UL>

<H4><A NAME="sec:3.7.1"><SPAN class="sec-nr">3.7.1</SPAN> <SPAN class="sec-title">Common 
server interface options</SPAN></A></H4>

<P>All the server interfaces provide <CODE>http_server(:Goal, +Options)</CODE> 
to create the server. The list of options differ, but the servers share 
common options:

<DL>
<DT><STRONG>port</STRONG>(<VAR>?Port</VAR>)</DT>
<DD class="defbody">
Specify the port to listen to for stand-alone servers. <VAR>Port</VAR> 
is either an integer or unbound. If unbound, it is unified to the 
selected free port.
</DD>
</DL>

<H4><A NAME="sec:3.7.2"><SPAN class="sec-nr">3.7.2</SPAN> <SPAN class="sec-title">Multi-threaded 
Prolog</SPAN></A></H4>

<A NAME="sec:mthttpd"></A>

<P>The <CODE>library(http/thread_httpd.pl)</CODE> provides the 
infrastructure to manage multiple clients using a pool of <EM>worker-threads</EM>. 
This realises a popular server design, also seen in Java Tomcat and 
Microsoft .NET. As a single persistent server process maintains 
communication to all clients startup time is not an important issue and 
the server can easily maintain state-information for all clients.

<P>In addition to the functionality provided by the other (XPCE and 
inetd) servers, the threaded server can also be used to realise an HTTPS 
server exploiting the <CODE>library(ssl)</CODE> library. See option
<CODE>ssl(+SSLOptions)</CODE> below.

<DL>
<DT class="pubdef"><A NAME="http_server/3"><STRONG>http_server</STRONG>(<VAR>:Goal, 
+Options</VAR>)</A></DT>
<DD class="defbody">
Create the server. <VAR>Options</VAR> must provide the <CODE>port(?Port)</CODE> 
option to specify the port the server should listen to. If <VAR>Port</VAR> 
is unbound an arbitrary free port is selected and <VAR>Port</VAR> is 
unified to this port-number. The server consists of a small Prolog 
thread accepting new connection on <VAR>Port</VAR> and dispatching these 
to a pool of workers. Defined <VAR>Options</VAR> are:

<DL>
<DT><STRONG>port</STRONG>(<VAR>?Port</VAR>)</DT>
<DD class="defbody">
Port the server should listen to. If unbound <VAR>Port</VAR> is unified 
with the selected free port.</DD>
<DT><STRONG>workers</STRONG>(<VAR>+N</VAR>)</DT>
<DD class="defbody">
Defines the number of worker threads in the pool. Default is to use
<VAR>two</VAR> workers. Choosing the optimal value for best performance 
is a difficult task depending on the number of CPUs in your system and 
how much resources are required for processing a request. Too high 
numbers makes your system switch too often between threads or even swap 
if there is not enough memory to keep all threads in memory, while a too 
low number causes clients to wait unnecessary for other clients to 
complete. See also <A NAME="idx:httpworkers2:59"></A><A class="pred" href="#http_workers/2">http_workers/2</A>.</DD>
<DT><STRONG>timeout</STRONG>(<VAR>+SecondsOrInfinite</VAR>)</DT>
<DD class="defbody">
Determines the maximum period of inactivity handling a request. If no 
data arrives within the specified time since the last data arrived the 
connection raises an exception, the worker discards the client and 
returns to the pool-queue for a new client. Default is <CODE>infinite</CODE>, 
making each worker wait forever for a request to complete. Without a 
timeout, a worker may wait forever on an a client that doesn't complete 
its request.</DD>
<DT><STRONG>keep_alive_timeout</STRONG>(<VAR>+SecondsOrInfinite</VAR>)</DT>
<DD class="defbody">
Maximum time to wait for new activity on <EM>Keep-Alive</EM> 
connections. Choosing the correct value for this parameter is hard. 
Disabling Keep-Alive is bad for performance if the clients request 
multiple documents for a single page. This may ---for example-- be 
caused by HTML frames, HTML pages with images, associated CSS files, 
etc. Keeping a connection open in the threaded model however prevents 
the thread servicing the client servicing other clients. The default is 
5 seconds.</DD>
<DT><STRONG>local</STRONG>(<VAR>+KBytes</VAR>)</DT>
<DD class="defbody">
Size of the local-stack for the workers. Default is taken from the 
commandline option.</DD>
<DT><STRONG>global</STRONG>(<VAR>+KBytes</VAR>)</DT>
<DD class="defbody">
Size of the global-stack for the workers. Default is taken from the 
commandline option.</DD>
<DT><STRONG>trail</STRONG>(<VAR>+KBytes</VAR>)</DT>
<DD class="defbody">
Size of the trail-stack for the workers. Default is taken from the 
commandline option.</DD>
<DT><STRONG>ssl</STRONG>(<VAR>+SSLOptions</VAR>)</DT>
<DD class="defbody">
Use SSL (Secure Socket Layer) rather than plan TCP/IP. A server created 
this way is accessed using the <CODE>https://</CODE> protocol. SSL 
allows for encrypted communication to avoid others from tapping the wire 
as well as improved authentication of client and server. The <VAR>SSLOptions</VAR> 
option list is passed to <A NAME="idx:sslinit3:60"></A><SPAN class="pred-ext">ssl_init/3</SPAN>. 
The port option of the main option list is forwarded to the SSL layer. 
See the <CODE>library(ssl)</CODE> library for details.
</DD>
</DL>

</DD>
<DT class="pubdef"><A NAME="http_current_server/2"><STRONG>http_current_server</STRONG>(<VAR>?:Goal, 
?Port</VAR>)</A></DT>
<DD class="defbody">
Query the running servers. Note that <A NAME="idx:httpserver3:61"></A><A class="pred" href="#http_server/3">http_server/3</A> 
can be called multiple times to create multiple servers on different 
ports.</DD>
<DT class="pubdef"><A NAME="http_workers/2"><STRONG>http_workers</STRONG>(<VAR>:Port, 
?Workers</VAR>)</A></DT>
<DD class="defbody">
Query or manipulate the number of workers of the server identified by
<VAR>Port</VAR>. If <VAR>Workers</VAR> is unbound it is unified with the 
number of running servers. If it is an integer greater than the current 
size of the worker pool new workers are created with the same 
specification as the running workers. If the number is less than the 
current size of the worker pool, this predicate inserts a number of 
`quit' requests in the queue, discarding the excess workers as they 
finish their jobs (i.e. no worker is abandoned while serving a client).

<P>This can be used to tune the number of workers for performance. 
Another possible application is to reduce the pool to one worker to 
facilitate easier debugging.</DD>
<DT class="pubdef"><A NAME="http_stop_server/2"><STRONG>http_stop_server</STRONG>(<VAR>+Port, 
+Options</VAR>)</A></DT>
<DD class="defbody">
Stop the HTTP server at Port. Halting a server is done
<I>gracefully</I>, which means that requests being processed are not 
abandoned. The <VAR>Options</VAR> list is for future refinements of this 
predicate such as a forced immediate abort of the server, but is 
currently ignored.</DD>
<DT class="pubdef"><A NAME="http_current_worker/2"><STRONG>http_current_worker</STRONG>(<VAR>?Port, 
?ThreadID</VAR>)</A></DT>
<DD class="defbody">
True if <VAR>ThreadID</VAR> is the identifier of a Prolog thread serving
<VAR>Port</VAR>. This predicate is motivated to allow for the use of 
arbitrary interaction with the worker thread for development and 
statistics.</DD>
<DT class="pubdef"><A NAME="http_spawn/2"><STRONG>http_spawn</STRONG>(<VAR>:Goal, 
+Spec</VAR>)</A></DT>
<DD class="defbody">
Continue handling this request in a new thread running <VAR>Goal</VAR>. 
After
<A NAME="idx:httpspawn2:62"></A><A class="pred" href="#http_spawn/2">http_spawn/2</A>, 
the worker returns to the pool to process new requests. In its simplest 
form, <VAR>Spec</VAR> is the name of a thread pool as defined by
<A NAME="idx:threadpoolcreate3:63"></A><SPAN class="pred-ext">thread_pool_create/3</SPAN>. 
Alternatively it is an option list, whose options are passed to <A NAME="idx:threadcreateinpool4:64"></A><SPAN class="pred-ext">thread_create_in_pool/4</SPAN> 
if <VAR>Spec</VAR> contains
<CODE>pool(Pool)</CODE> or to <A NAME="idx:threadcreate3:65"></A><SPAN class="pred-ext">thread_create/3</SPAN> 
of the pool option is not present. If the dispatch module is used (see <A class="sec" href="#sec:3.2">section 
3.2</A>), spawning is normally specified as an option to the <A NAME="idx:httphandler3:66"></A><A class="pred" href="#http_handler/3">http_handler/3</A> 
registration.

<P>We recomment the use of thread pools. They allow registration of a 
set of threads using common characteristics, specify how many can be 
active and what to do if all threads are active. A typical application 
may define a small pool of threads with large stacks for computation 
intensive tasks, and a large pool of threads with small stacks to serve 
media. The declaration could be the one below, allowing for max 3 
concurrent solvers and a maximum backlog of 5 and 30 tasks creating 
image thumbnails.

<PRE class="code">
:- use_module(library(thread_pool)).

:- thread_pool_create(compute, 3,
                      [ local(20000), global(100000), trail(50000),
                        backlog(5)
                      ]).
:- thread_pool_create(media, 30,
                      [ local(100), global(100), trail(100),
                        backlog(100)
                      ]).

:- http_handler('/solve',     solve,     [spawn(compute)]).
:- http_handler('/thumbnail', thumbnail, [spawn(media)]).
</PRE>

<P></DD>
</DL>

<H4><A NAME="sec:3.7.3"><SPAN class="sec-nr">3.7.3</SPAN> <SPAN class="sec-title">From 
an interactive Prolog session using XPCE</SPAN></A></H4>

<P>The <CODE>library(http/xpce_httpd.pl)</CODE> provides the 
infrastructure to manage multiple clients with an event-driven 
control-structure. This version can be started from an interactive 
Prolog session, providing a comfortable infra-structure to debug the 
body of your server. It also allows the combination of an (XPCE-based) 
GUI with web-technology in one application.

<DL>
<DT class="pubdef"><A NAME="http_server/2"><STRONG>http_server</STRONG>(<VAR>:Goal, 
+Options</VAR>)</A></DT>
<DD class="defbody">
Create an instance of <B>interactive_httpd</B>. <VAR>Options</VAR> must 
provide the <CODE>port(?Port)</CODE> option to specify the port the 
server should listen to. If <VAR>Port</VAR> is unbound an arbitrary free 
port is selected and <VAR>Port</VAR> is unified to this port-number. 
Currently no options are defined.
</DD>
</DL>

<P>The file <CODE>demo_xpce</CODE> gives a typical example of this 
wrapper, assuming <CODE>demo_body</CODE> defines the predicate <A NAME="idx:reply1:67"></A><SPAN class="pred-ext">reply/1</SPAN>.

<PRE class="code">
:- use_module(xpce_httpd).
:- use_module(demo_body).

server(Port) :-
        http_server(reply, Port, []).
</PRE>

<P>The created server opens a server socket at the selected address and 
waits for incoming connections. On each accepted connection it collects 
input until an HTTP request is complete. Then it opens an input stream 
on the collected data and using the output stream directed to the XPCE
<B>socket</B> it calls <A NAME="idx:httpwrapper5:68"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A>. 
This approach is fundamentally different compared to the other 
approaches:

<P>
<UL>
<LI><I>Server can handle multiple connections</I><BR>
When <EM>inetd</EM> will start a server for each <EM>client</EM>, and 
CGI starts a server for each <EM>request</EM>, this approach starts a 
single server handling multiple clients.

<P>
<LI><I>Requests are serialised</I><BR>
All calls to <VAR>Goal</VAR> are fully serialised, processing on behalf 
of a new client can only start after all previous requests are answered. 
This easier and quite acceptable if the server is mostly inactive and 
requests take not very long to process.

<P>
<LI><I>Lifetime of the server</I><BR>
The server lives as long as Prolog runs.
</UL>

<H4><A NAME="sec:3.7.4"><SPAN class="sec-nr">3.7.4</SPAN> <SPAN class="sec-title">From 
(Unix) inetd</SPAN></A></H4>

<P>All modern Unix systems handle a large number of the services they 
run through the super-server <EM>inetd</EM>. This program reads
<CODE>/etc/inetd.conf</CODE> and opens server-sockets on all ports 
defined in this file. As a request comes in it accepts it and starts the 
associated server such that standard I/O refers to the socket. This 
approach has several advantages:

<P>
<UL>
<LI><I>Simplification of servers</I><BR>
Servers don't have to know about sockets and -operations.

<P>
<LI><I>Centralised authorisation</I><BR>
Using <EM>tcpwrappers</EM> simple and effective firewalling of all 
services is realised.

<P>
<LI><I>Automatic start and monitor</I><BR>
The inetd automatically starts the server `just-in-time' and starts 
additional servers or restarts a crashed server according to the 
specifications.
</UL>

<P>The very small generic script for handling inetd based connections is 
in <CODE>inetd_httpd</CODE>, defining <A NAME="idx:httpserver1:69"></A><SPAN class="pred-ext">http_server/1</SPAN>:

<DL>
<DT class="pubdef"><A NAME="http_server/2"><STRONG>http_server</STRONG>(<VAR>:Goal, 
+Options</VAR>)</A></DT>
<DD class="defbody">
Initialises and runs <A NAME="idx:httpwrapper5:70"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A> 
in a loop until failure or end-of-file. This server does not support the <VAR>Port</VAR> 
option as the port is specified with the <B>inetd</B> configuration. The 
only supported option is <VAR>After</VAR>.
</DD>
</DL>

<P>Here is the example from <CODE>demo_inetd</CODE>

<PRE class="code">
#!/usr/bin/pl -t main -q -f
:- use_module(demo_body).
:- use_module(inetd_httpd).

main :-
        http_server(reply).
</PRE>

<P>With the above file installed in <CODE>/home/jan/plhttp/demo_inetd</CODE>, 
the following line in <CODE>/etc/inetd</CODE> enables the server at port 
4001 guarded by <EM>tcpwrappers</EM>. After modifying inetd, send the 
daemon the <CODE>HUP</CODE> signal to make it reload its configuration. 
For more information, please check <STRONG>inetd.conf</STRONG>(5).

<PRE class="code">
4001 stream tcp nowait nobody /usr/sbin/tcpd /home/jan/plhttp/demo_inetd
</PRE>

<H4><A NAME="sec:3.7.5"><SPAN class="sec-nr">3.7.5</SPAN> <SPAN class="sec-title">MS-Windows</SPAN></A></H4>

<P>There are rumours that <EM>inetd</EM> has been ported to Windows.

<H4><A NAME="sec:3.7.6"><SPAN class="sec-nr">3.7.6</SPAN> <SPAN class="sec-title">As 
CGI script</SPAN></A></H4>

<P>To be done.

<H4><A NAME="sec:3.7.7"><SPAN class="sec-nr">3.7.7</SPAN> <SPAN class="sec-title">Using 
a reverse proxy</SPAN></A></H4>

<A NAME="sec:proxy"></A>

<P>There are three options for public deployment of a service. One is to 
run it on a dedicated machine on port 80, the standard HTTP port. The 
machine may be a virtual machine running ---for example--- under
<A class="url" href="http://www.vmware.com">VMWARE</A> or
<A class="url" href="http://www.cl.cam.ac.uk/research/srg/netos/xen/">XEN</A>. 
The (virtual) machine approach isolates security threads and allows for 
using a standard port. The server can also be hosted on a non-standard 
port such as 8000, or 8080. Using non-standard ports however may cause 
problems with intermediate proxy- and/or firewall policies. Isolation 
can be achieved using a Unix <EM>chroot</EM> environment. Another 
option, also recommended for <EM>Tomcat</EM> servers, is the use of 
Apache <EM>reverse proxies</EM>. This causes the main web-server to 
relay requests below a given URL location to our Prolog based server. 
This approach has several advantages:

<P>
<UL>
<LI>We can access the server on port 80, just as for a dedicated 
machine. We do not need a machine though and we only need access to the 
Apache configuration.
<LI>As Apache is doing the front-line service, the Prolog server is 
normally protected from malformed HTTP requests that could result in 
denial of service or otherwise compromise the server. In addition, 
Apache can provide encodings such as compression to the outside world.
</UL>

<P>Note that the proxy technology can be combined with isolation methods 
such as dedicated machines, virtual machines and chroot jails. The proxy 
can also provide load balancing.

<P><B>Setting up a reverse proxy</B> 

<P>The Apache reverse proxy setup is really simple. Ensure the modules
<CODE>proxy</CODE> and <CODE>proxy_http</CODE> are loaded. Then add two 
simple rules to the server configuration. Below is an example that makes 
a PlDoc server on port 4000 available from the main Apache server at 
port 80.

<PRE class="code">
ProxyPass        /pldoc/ http://localhost:4000/pldoc/
ProxyPassReverse /pldoc/ http://localhost:4000/pldoc/
</PRE>

<P>Apache rewrites the HTTP headers passing by, but using the above 
rules it does not examine the content. This implies that URLs embedded 
in the (HTML) content must use relative addressing. If the locations on 
the public and Prolog server are the same (as in the example above) it 
is allowed to use absolute locations. I.e. <CODE>/pldoc/search</CODE> is 
ok, but <CODE>http://myhost.com:4000/pldoc/search</CODE> is <EM>not</EM>. 
If the locations on the server differ, locations must be relative (i.e. not 
start with <CODE>/</CODE>.

<P>This problem can also be solved using the contributed Apache module
<CODE>proxy_html</CODE> that can be instructed to rewrite URLs embedded 
in HTML documents. In our experience, this is not troublefree as URLs 
can appear in many places in generated documents. JavaScript can create 
URLs on the fly, which makes rewriting virtually impossible.

<H3><A NAME="sec:3.8"><SPAN class="sec-nr">3.8</SPAN> <SPAN class="sec-title">The 
wrapper library</SPAN></A></H3>

<P>The body is called by the module <CODE>library(http/http_wrapper.pl)</CODE>. 
This module realises the communication between the I/O streams and the 
body described in <A class="sec" href="#sec:3.1">section 3.1</A>. The 
interface is realised by
<A NAME="idx:httpwrapper5:71"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A>:

<DL>
<DT class="pubdef"><A NAME="http_wrapper/5"><STRONG>http_wrapper</STRONG>(<VAR>:Goal, 
+In, +Out, -Connection, +Options</VAR>)</A></DT>
<DD class="defbody">
Handle an HTTP request where <VAR>In</VAR> is an input stream from the 
client, <VAR>Out</VAR> is an output stream to the client and <VAR>Goal</VAR> 
defines the goal realising the body. <VAR>Connection</VAR> is unified to
<CODE>'Keep-alive'</CODE> if both ends of the connection want to 
continue the connection or <CODE>close</CODE> if either side wishes to 
close the connection.

<P>This predicate reads an HTTP request-header from <VAR>In</VAR>, 
redirects current output to a memory file and then runs <CODE>call(Goal, 
Request)</CODE>, watching for exceptions and failure. If <VAR>Goal</VAR> 
executes successfully it generates a complete reply from the created 
output. Otherwise it generates an HTTP server error with additional 
context information derived from the exception.

<P><A NAME="idx:httpwrapper5:72"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A> 
supports the following options:

<DL>
<DT><STRONG>request</STRONG>(<VAR>-Request</VAR>)</DT>
<DD class="defbody">
Return the executed request to the caller.</DD>
<DT><STRONG>peer</STRONG>(<VAR>+Peer</VAR>)</DT>
<DD class="defbody">
Add peer(Peer) to the request header handed to <VAR>Goal</VAR>. The 
format of <VAR>Peer</VAR> is defined by <A NAME="idx:tcpaccept3:73"></A><SPAN class="pred-ext">tcp_accept/3</SPAN> 
from the clib package.
</DD>
</DL>

</DD>
<DT class="pubdef"><A NAME="http:request_expansion/2"><STRONG>http:request_expansion</STRONG>(<VAR>+RequestIn, 
-RequestOut</VAR>)</A></DT>
<DD class="defbody">
This <EM>multifile</EM> hook predicate is called just before the goal 
that produces the body, while the output is already redirected to 
collect the reply. If it succeeds it must return a valid modified 
request. It is allowed to throw exceptions as defined in
<A class="sec" href="#sec:3.1.1">section 3.1.1</A>. It is intended for 
operations such as mapping paths, deny access for certain requests or 
manage cookies. If it writes output, these must be HTTP header fields 
that are added <EM>before</EM> header fields written by the body. The 
example below is from the session management library (see <A class="sec" href="#sec:3.3">section 
3.3</A>) sets a cookie.

<PRE class="code">
        ...,
        format('Set-Cookie: ~w=~w; path=~w~n', [Cookie, SessionID, Path]),
        ...,
</PRE>

</DD>
<DT class="pubdef"><A NAME="http_current_request/1"><STRONG>http_current_request</STRONG>(<VAR>-Request</VAR>)</A></DT>
<DD class="defbody">
Get access to the currently executing request. <VAR>Request</VAR> is the 
same as handed to <VAR>Goal</VAR> of <A NAME="idx:httpwrapper5:74"></A><A class="pred" href="#http_wrapper/5">http_wrapper/5</A> <EM>after</EM> 
applying rewrite rules as defined by http:request_expansion/2. Raises an 
existence error if there is no request in progress.</DD>
<DT class="pubdef"><A NAME="http_relative_path/2"><STRONG>http_relative_path</STRONG>(<VAR>+AbsPath, 
-RelPath</VAR>)</A></DT>
<DD class="defbody">
Convert an absolute path (without host, fragment or search) into a path 
relative to the current page, defined as the path component from the 
current request (see <A NAME="idx:httpcurrentrequest1:75"></A><A class="pred" href="#http_current_request/1">http_current_request/1</A>). 
This call is intended to create reusable components returning relative 
paths for easier support of reverse proxies.

<P>If ---for whatever reason--- the conversion is not possible it simply 
unifies <VAR>RelPath</VAR> to <VAR>AbsPath</VAR>.
</DD>
</DL>

<H3><A NAME="sec:3.9"><SPAN class="sec-nr">3.9</SPAN> <SPAN class="sec-title">http_log.pl 
-- HTTP Logging module</SPAN></A></H3>

<P><A NAME="sec:httplog"></A>

<P>Simple module for logging HTTP requests to a file. Logging is enabled 
by loading this file and ensure the setting http:logfile is not the 
empty atom. The default file for writing the log is <CODE>httpd.log</CODE>. 
See library(settings) for details.

<P>The level of logging can modified using the multifile predicate 
http_log:<SPAN class="pred-ext">nolog/1</SPAN> to hide HTTP request 
fields from the logfile and http_log:<SPAN class="pred-ext">password_field/1</SPAN> 
to hide passwords from HTTP search specifications (e.g. <CODE>/topsecret?password=secret</CODE>.

<DL>
<DT class="pubdef"><span class="pred-tag">[semidet]</span><A NAME="http_log_stream/1"><STRONG>http_log_stream</STRONG>(<VAR>-Stream</VAR>)</A></DT>
<DD class="defbody">
Returns handle to open logfile. Fails if no logfile is open and none is 
defined.</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="http_log/2"><STRONG>http_log</STRONG>(<VAR>+Format, 
+Args</VAR>)</A></DT>
<DD class="defbody">
Write message from <VAR>Format</VAR> and <VAR>Args</VAR> to log-stream. 
See <SPAN class="pred-ext">format/2</SPAN> for details. Succeed without 
side effects if logging is not enabled.
</DD>
</DL>

<H3><A NAME="sec:3.10"><SPAN class="sec-nr">3.10</SPAN> <SPAN class="sec-title">Debugging 
Servers</SPAN></A></H3>

<A NAME="sec:debug"></A>

<P>The library <CODE>library(http/http_error.pl)</CODE> defines a hook 
that decorates uncaught exceptions with a stack-trace. This will 
generate a <EM>500 internal server error</EM> document with a 
stack-trace. To enable this feature, simply load this library. Please do 
note that providing error information to the user simplifies the job of 
a hacker trying to compromise your server. It is therefore not 
recommended to load this file by default.

<P>The example program <CODE>calc.pl</CODE> has the error handler loaded 
which can be triggered by forcing a divide-by-zero in the calculator.

<H3><A NAME="sec:3.11"><SPAN class="sec-nr">3.11</SPAN> <SPAN class="sec-title">Handling 
HTTP headers</SPAN></A></H3>

<A NAME="sec:httpheader"></A>

<P>The library <CODE>library(http/http_header)</CODE> provides 
primitives for parsing and composing HTTP headers. Its functionality is 
normally hidden by the other parts of the HTTP server and client 
libraries. We provide a brief overview of <A NAME="idx:httpreply3:76"></A><A class="pred" href="#http_reply/3">http_reply/3</A> 
which can be accessed from the reply body using an exception as explain 
in <A class="sec" href="#sec:3.1.1">section 3.1.1</A>.

<DL>
<DT class="pubdef"><A NAME="http_reply/3"><STRONG>http_reply</STRONG>(<VAR>+Type, 
+Stream, +HdrExtra</VAR>)</A></DT>
<DD class="defbody">
Compose a complete HTTP reply from the term <VAR>Type</VAR> using 
additional headers from <VAR>HdrExtra</VAR> to the output stream <VAR>Stream</VAR>.
<VAR>ExtraHeader</VAR> is a list of <CODE>Field(Value)</CODE>. <VAR>Type</VAR> 
is one of:

<DL>
<DT><STRONG>html</STRONG>(<VAR>+HTML</VAR>)</DT>
<DD class="defbody">
Produce a HTML page using <A NAME="idx:printhtml1:77"></A><A class="pred" href="#print_html/1">print_html/1</A>, 
normally generated using the
<CODE>library(http/html_write)</CODE> described in <A class="sec" href="#sec:3.12">section 
3.12</A>.</DD>
<DT><STRONG>file</STRONG>(<VAR>+MimeType, +Path</VAR>)</DT>
<DD class="defbody">
Reply the content of the given file, indicating the given MIME type.</DD>
<DT><STRONG>tmp_file</STRONG>(<VAR>+MimeType, +Path</VAR>)</DT>
<DD class="defbody">
Similar to <CODE>File(+MimeType, +Path)</CODE>, but do not include a 
modification time header.</DD>
<DT><STRONG>stream</STRONG>(<VAR>+Stream, +Len</VAR>)</DT>
<DD class="defbody">
Reply using the next <VAR>Len</VAR> characters from <VAR>Stream</VAR>. 
The user must provides the MIME type and other attributes through the
<VAR>ExtraHeader</VAR> argument.</DD>
<DT><STRONG>cgi_stream</STRONG>(<VAR>+Stream, +Len</VAR>)</DT>
<DD class="defbody">
Similar to <CODE>stream(+Stream, +Len)</CODE>, but the data on <VAR>Stream</VAR> 
must contain an HTTP header.</DD>
<DT><STRONG>moved</STRONG>(<VAR>+URL</VAR>)</DT>
<DD class="defbody">
Generate a ``301 Moved Permanently'' page with the given target
<VAR>URL</VAR>.</DD>
<DT><STRONG>moved_temporary</STRONG>(<VAR>+URL</VAR>)</DT>
<DD class="defbody">
Generate a ``302 Moved Temporary'' page with the given target
<VAR>URL</VAR>.</DD>
<DT><STRONG>see_other</STRONG>(<VAR>+URL</VAR>)</DT>
<DD class="defbody">
Generate a ``303 See Other'' page with the given target <VAR>URL</VAR>.</DD>
<DT><STRONG>not_found</STRONG>(<VAR>+URL</VAR>)</DT>
<DD class="defbody">
Generate a ``404 Not Found'' page.</DD>
<DT><STRONG>forbidden</STRONG>(<VAR>+URL</VAR>)</DT>
<DD class="defbody">
Generate a ``403 Forbidden'' page, denying access without challenging 
the client.</DD>
<DT><STRONG>authorise</STRONG>(<VAR>+Method, +Realm</VAR>)</DT>
<DD class="defbody">
Generate a ``401 Authorization Required'', requesting the client to 
retry using proper credentials (i.e. user and password).</DD>
<DT><STRONG>not_modified</STRONG></DT>
<DD class="defbody">
Generate a ``304 Not Modified'' page, indicating the requested resource 
has not changed since the indicated time.</DD>
<DT><STRONG>server_error</STRONG>(<VAR>+Error</VAR>)</DT>
<DD class="defbody">
Generate a ``500 Internal server error'' page with a message generated 
from a Prolog exception term (see <A NAME="idx:printmessage2:78"></A><SPAN class="pred-ext">print_message/2</SPAN>).
</DD>
</DL>

</DD>
</DL>

<H3><A NAME="sec:3.12"><SPAN class="sec-nr">3.12</SPAN> <SPAN class="sec-title">The <CODE>library(http/html_write)</CODE> 
library</SPAN></A></H3>

<A NAME="sec:htmlwrite"></A>

<P>Producing output for the web in the form of an HTML document is a 
requirement for many Prolog programs. Just using <A NAME="idx:format2:79"></A><SPAN class="pred-ext">format/2</SPAN> 
is satisfactory as it leads to poorly readable programs generating poor 
HTML. This library is based on using DCG rules.

<P>The <CODE>library(http/html_write)</CODE> structures the generation 
of HTML from a program. It is an extensible library, providing a <EM>DCG</EM> 
framework for generating legal HTML under (Prolog) program control. It 
is especially useful for the generation of structured pages (e.g. tables) 
from Prolog data structures.

<P>The normal way to use this library is through the DCG html//1. This 
non-terminal provides the central translation from a structured term 
with embedded calls to additional translation rules to a list of atoms 
that can then be printed using <A NAME="idx:printhtml12:80"></A><A class="pred" href="#print_html/1">print_html/[1,2]</A>.

<DL>
<DT class="pubdef"><A NAME="html/1"><STRONG>html</STRONG>(<VAR>:Spec</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
The DCG non-terminal html//1 is the main predicate of this library. It 
translates the specification for an HTML page into a list of atoms that 
can be written to a stream using <A NAME="idx:printhtml12:81"></A><A class="pred" href="#print_html/1">print_html/[1,2]</A>. 
The expansion rules of this predicate may be extended by defining the 
multifile DCG html_write:expand//1. <VAR>Spec</VAR> is either a single 
specification or a list of single specifications. Using nested lists is 
not allowed to avoid ambiguity caused by the atom <CODE>[]</CODE>

<P>
<UL>
<LI><I>Atomic data</I><BR>
Atomic data is quoted using html_quoted//1.

<P>
<LI><I><VAR>Fmt</VAR> - <VAR>Args</VAR></I><BR>
<VAR>Fmt</VAR> and <VAR>Args</VAR> are used as format-specification and 
argument list to <A NAME="idx:sformat3:82"></A><SPAN class="pred-ext">sformat/3</SPAN>. 
The result is quoted and added to the output list.

<P>
<LI><I><CODE>\</CODE><VAR>List</VAR></I><BR>
Escape sequence to add atoms directly to the output list. This can be 
used to embed external HTML code.

<P>
<LI><I><CODE>\</CODE><VAR>Term</VAR></I><BR>
Invoke the non-terminal <VAR>Term</VAR> in the calling module. This is 
the common mechanism to realise abstraction and modularisation in 
generating HTML.

<P>
<LI><I><VAR>Module</VAR>:<VAR>Term</VAR></I><BR>
Invoke the non-terminal &lt;<VAR>Module</VAR>&gt;:&lt;<VAR>Term</VAR>&gt;. 
This is similar to
<CODE>\</CODE><VAR>Term</VAR> but allows for invoking grammar rules in 
external packages.

<P>
<LI><I>&amp;(Entity)</I><BR>
Emit <TT>&amp;&lt;<VAR>Entity</VAR>&gt;;</TT>. As Prolog understands 
Unicode and automatically inserts appropriate entity declarations, this 
is normally not needed.

<P>
<LI><I><CODE>Tag(Content)</CODE></I><BR>
Emit HTML element <VAR>Tag</VAR> using <VAR>Content</VAR> and no 
attributes.
<VAR>Content</VAR> is handed to html//1. See <A class="sec" href="#sec:3.12.4">section 
3.12.4</A> for details on the automatically generated layout.

<P>
<LI><I><CODE>Tag(Attributes, Content)</CODE></I><BR>
Emit HTML element <VAR>Tag</VAR> using <VAR>Attributes</VAR> and <VAR>Content</VAR>.
<VAR>Attributes</VAR> is either a single attribute of a list of 
attributes. Each attributes is of the format <CODE>Name(Value)</CODE> or
<VAR>Name</VAR>=<VAR>Value</VAR>. <VAR>Value</VAR> is the atomic 
attribute value but allows for a limited functional notation:

<P>
<UL>
<LI><I><VAR>A</VAR> + <VAR>B</VAR></I><BR>
Concatenation of <VAR>A</VAR> and <VAR>B</VAR>
<LI><I><CODE>encode(Atom)</CODE></I><BR>
Use <A NAME="idx:wwwformencode2:83"></A><SPAN class="pred-ext">www_form_encode/2</SPAN> 
to create a valid URL component.
<LI><I><CODE>location_by_id(ID)</CODE></I><BR>
HTTP location of the HTTP handler with given ID. See <A NAME="idx:httplocationbyid2:84"></A><A class="pred" href="#http_location_by_id/2">http_location_by_id/2</A>.
<LI><I>List</I><BR>
A list is handled as a URL `search' component. The list members are 
terms of the format <VAR>Name</VAR> = <VAR>Value</VAR> or
<CODE>Name(Value)</CODE>. Values are encoded as in the encode option 
described above.
</UL>

<P>The example below generates a URL that references the predicate
<A NAME="idx:setlang1:85"></A><SPAN class="pred-ext">set_lang/1</SPAN> 
in the application with given parameters. The <A NAME="idx:httphandler3:86"></A><A class="pred" href="#http_handler/3">http_handler/3</A> 
declaration binds <CODE>/setlang</CODE> to the predicate <A NAME="idx:setlang1:87"></A><SPAN class="pred-ext">set_lang/1</SPAN> 
for which we provide a very simple implementation. The code between <CODE>...</CODE> 
is part of an HTML page showing the english flag which, when pressed, 
calls <CODE>set_lang(Request)</CODE> where <VAR>Request</VAR> contains 
the search parameter <CODE>lang</CODE> = <CODE>en</CODE>. Note that the 
HTTP location (path) <CODE>/setlang</CODE> can be moved without 
affecting this code.

<PRE class="code">
:- http_handler('/setlang', set_lang, []).

set_lang(Request) :-
        http_parameters(Request,
                        [ lang(Lang, [])
                        ]),
        http_session_retractall(lang(_)),
        http_session_assert(lang(Lang)),
        reply_html_page(title('Switched language'),
                        p(['Switch language to ', Lang])).


        ...
        html(a(href(location_by_id(set_lang) + [lang(en)]),
               img(src('/www/images/flags/en.png')))),
        ...
</PRE>

<P>
</UL>
</DD>
<DT class="pubdef"><A NAME="page/2"><STRONG>page</STRONG>(<VAR>:HeadContent, 
:BodyContent</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
The DCG non-terminal page//2 generated a complete page, including the 
SGML
<CODE>DOCTYPE</CODE> declaration. <VAR>HeadContent</VAR> are elements to 
be placed in the <CODE>head</CODE> element and <VAR>BodyContent</VAR> 
are elements to be placed in the <CODE>body</CODE> element.

<P>To achieve common style (background, page header and footer), it is 
possible to define DCG non-terminals head//1 and/or body//1. 
Non-terminal page//1 checks for the definition of these non-terminals in 
the module it is called from as well as in the <CODE>user</CODE> module. 
If no definition is found, it creates a head with only the <VAR>HeadContent</VAR> 
(note that the
<CODE>title</CODE> is obligatory) and a <CODE>body</CODE> with <CODE>bgcolor</CODE> 
set to <CODE>white</CODE> and the provided <VAR>BodyContent</VAR>.

<P>Note that further customisation is easily achieved using html//1 
directly as page//2 is (besides handling the hooks) defined as:

<PRE class="code">
page(Head, Body) --&gt;
        html([ \['&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 4.0//EN"&gt;\n'],
               html([ head(Head),
                      body(bgcolor(white), Body)
                    ])
             ]).
</PRE>

</DD>
<DT class="pubdef"><A NAME="page/1"><STRONG>page</STRONG>(<VAR>:Contents</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
This version of the <A NAME="idx:page12:88"></A><A class="pred" href="#page/1">page/[1,2]</A> 
only gives you the SGML <CODE>DOCTYPE</CODE> and the <CODE>HTML</CODE> 
element. <VAR>Contents</VAR> is used to generate both the head and body 
of the page.</DD>
<DT class="pubdef"><A NAME="html_begin/1"><STRONG>html_begin</STRONG>(<VAR>+Begin</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Just open the given element. <VAR>Begin</VAR> is either an atom or a 
compound term, In the latter case the arguments are used as arguments to 
the begin-tag. Some examples:

<PRE class="code">
        html_begin(table)
        html_begin(table(border(2), align(center)))
</PRE>

<P>This predicate provides an alternative to using the
<CODE>\</CODE><VAR>Command</VAR> syntax in the html//1 specification. 
The following two fragments are the same. The preferred solution depends 
on your preferences as well as whether the specification is generated or 
entered by the programmer.

<PRE class="code">
table(Rows) --&gt;
        html(table([border(1), align(center), width('80%')],
                   [ \table_header,
                     \table_rows(Rows)
                   ])).

% or

table(Rows) --&gt;
        html_begin(table(border(1), align(center), width('80%'))),
        table_header,
        table_rows,
        html_end(table).
</PRE>

</DD>
<DT class="pubdef"><A NAME="html_end/1"><STRONG>html_end</STRONG>(<VAR>+End</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
End an element. See <A NAME="idx:htmlbegin1:89"></A><A class="pred" href="#html_begin/1">html_begin/1</A> 
for details.
</DD>
</DL>

<H4><A NAME="sec:3.12.1"><SPAN class="sec-nr">3.12.1</SPAN> <SPAN class="sec-title">Emitting 
HTML documents</SPAN></A></H4>

<P>The non-terminal html//1 translates a specification into a list of 
atoms and layout instructions. Currently the layout instructions are 
terms of the format <CODE>nl(N)</CODE>, requesting at least <VAR>N</VAR> 
newlines. Multiple consecutive <CODE>nl(1)</CODE> terms are combined to 
an atom containing the maximum of the requested number of newline 
characters.

<P>To simplify handing the data to a client or storing it into a file, 
the following predicates are available from this library:

<DL>
<DT class="pubdef"><A NAME="reply_html_page/2"><STRONG>reply_html_page</STRONG>(<VAR>:Head, 
:Body</VAR>)</A></DT>
<DD class="defbody">
Writes an HTML page preceded by an HTTP header as required by <CODE>library(http_wrapper)</CODE> 
(CGI-style). Here is a simple typical example:

<PRE class="code">
reply(Request) :-
        reply_html_page(title('Welcome'),
                        [ h1('Welcome'),
                          p('Welcome to our ...')
                        ]).
</PRE>

</DD>
<DT class="pubdef"><A NAME="print_html/1"><STRONG>print_html</STRONG>(<VAR>+List</VAR>)</A></DT>
<DD class="defbody">
Print the token list to the Prolog current output stream.</DD>
<DT class="pubdef"><A NAME="print_html/2"><STRONG>print_html</STRONG>(<VAR>+Stream, 
+List</VAR>)</A></DT>
<DD class="defbody">
Print the token list to the specified output stream</DD>
<DT class="pubdef"><A NAME="html_print_length/2"><STRONG>html_print_length</STRONG>(<VAR>+List, 
-Length</VAR>)</A></DT>
<DD class="defbody">
When calling <A NAME="idx:htmlprint12:90"></A><SPAN class="pred-ext">html_print/[1,2]</SPAN> 
on <VAR>List</VAR>, <VAR>Length</VAR> characters will be produced. 
Knowing the length is needed to provide the <CODE>Content-length</CODE> 
field of an HTTP reply-header.
</DD>
</DL>

<H4><A NAME="sec:3.12.2"><SPAN class="sec-nr">3.12.2</SPAN> <SPAN class="sec-title">Repositioning 
HTML for CSS and javascript links</SPAN></A></H4>

<P>Modern HTML commonly uses CSS and Javascript. This requires <VAR>&lt;</VAR>link<VAR>&gt;</VAR> 
elements in the HTML <VAR>&lt;</VAR>head<VAR>&gt;</VAR> element or <VAR>&lt;</VAR>script<VAR>&gt;</VAR> 
elements in the <VAR>&lt;</VAR>body<VAR>&gt;</VAR>. Unfortunately this 
seriously harms re-using HTML DCG rules as components as each of these 
components may rely on their own style sheets or JavaScript code. We 
added a `mailing' system to reposition and collect fragments of HTML. 
This is implemented by <SPAN class="pred-ext">html_post/4</SPAN>, <SPAN class="pred-ext">html_receive/3</SPAN> 
and <SPAN class="pred-ext">html_receive/4</SPAN>.

<DL>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="html_post/2"><STRONG>html_post</STRONG>(<VAR>+Id, 
:HTML</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Reposition <VAR>HTML</VAR> to the receiving <VAR>Id</VAR>. The <A class="pred" href="#http_post/4">http_post/4</A> 
call processes <VAR>HTML</VAR> using <SPAN class="pred-ext">html/3</SPAN>. 
Embedded <CODE>\</CODE>-commands are executed by <SPAN class="pred-ext">mainman/1</SPAN> 
from <A class="pred" href="#print_html/1">print_html/1</A> or <A class="pred" href="#html_print_length/2">html_print_length/2</A>. 
These commands are called in the calling context of the <SPAN class="pred-ext">html_post/4</SPAN> 
call.

<P>A typical usage scenario is to get required CSS links in the document 
head in a reusable fashion. First, we define <SPAN class="pred-ext">css/3</SPAN> 
as:

<PRE class="code">
css(URL) --&gt;
        html_post(css,
                  link([ type('text/css'),
                         rel('stylesheet'),
                         href(URL)
                       ])).
</PRE>

<P>Next we insert the <I>unique</I> CSS links, in the pagehead using the 
following call to <A class="pred" href="#reply_html_page/2">reply_html_page/2</A>:

<PRE class="code">
        reply_html_page([ title(...),
                          \html_receive(css)
                        ],
                        ...)
</PRE>

</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="html_receive/1"><STRONG>html_receive</STRONG>(<VAR>+Id</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Receive posted HTML tokens. Unique sequences of tokens posted with <SPAN class="pred-ext">html_post/4</SPAN> 
are inserted at the location where
<SPAN class="pred-ext">html_receive/3</SPAN> appears.

<DL>
<DT><B>See also</B><DD>- The local predicate <SPAN class="pred-ext">sorted_html/3</SPAN> 
handles the output of
<SPAN class="pred-ext">html_receive/3</SPAN>. <BR>
- <SPAN class="pred-ext">html_receive/4</SPAN> allows for 
post-processing the posted material.
</DL>

</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="html_receive/2"><STRONG>html_receive</STRONG>(<VAR>+Id, 
:Handler</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
This extended version of <SPAN class="pred-ext">html_receive/3</SPAN> 
causes <VAR>Handler</VAR> to be called to process all messages posted to 
the channal at the time output is generated. <VAR>Handler</VAR> is a 
grammar rule that is called with three extra arguments.

<P><OL>
<LI>A list of Module:Term, of posted terms. Module is the contest module 
of html_post and Term is the unmodified term. Members are in the order 
posted and may contain duplicates.
<LI>DCG input list. The final output must be produced by a call to <SPAN class="pred-ext">html/3</SPAN>.
<LI>DCG output list.
</OL>

<P>Typically, <VAR>Handler</VAR> collects the posted terms, creating a 
term suitable for <SPAN class="pred-ext">html/3</SPAN> and finally calls <SPAN class="pred-ext">html/3</SPAN>.
</DD>
</DL>

<P>The library predefines the receiver channel <CODE>head</CODE> at the 
end of the
<CODE>head</CODE> element for all pages that write the html <CODE>head</CODE> 
through this library. The following code can be used anywhere inside an 
HTML generating rule to demand a javascript in the header:

<PRE class="code">
js_script(URL) --&gt;
        html_post(head, script([ src(URL),
                                 type('text/javascript')
                               ], [])).
</PRE>

<P>This mechanism is also exploited to add XML namespace (<CODE>xmlns</CODE>) 
declarations to the (outer) <CODE>html</CODE> element using <SPAN class="pred-ext">xhml_ns/4</SPAN>:

<DL>
<DT class="pubdef"><A NAME="xhtml_ns/2"><STRONG>xhtml_ns</STRONG>(<VAR>Id, 
Value</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Demand an xmlns:id=<VAR>Value</VAR> in the outer html tag. This uses the
<A class="pred" href="#html_post/2">html_post/2</A> mechanism to post to 
the <CODE>xmlns</CODE> channel. Rdfa (<A class="url" href="http://www.w3.org/2006/07/SWD/RDFa/syntax/),">http://www.w3.org/2006/07/SWD/RDFa/syntax/),</A> 
embedding RDF in (x)html provides a typical usage scenario where we want 
to publish the required namespaces in the header. We can define:

<PRE class="code">
rdf_ns(Id) --&gt;
        { rdf_global_id(Id:'', Value) },
        xhtml_ns(Id, Value).
</PRE>

<P>After which we can use <SPAN class="pred-ext">rdf_ns/3</SPAN> as a 
normal rule in <SPAN class="pred-ext">html/3</SPAN> to publish 
namespaces from library(semweb/rdf_db). Note that this macro only has 
effect if the dialect is set to <CODE>xhtml</CODE>. In
<CODE>html</CODE> mode it is silently ignored.

<P>The required <CODE>xmlns</CODE> receiver is installed by <SPAN class="pred-ext">html_begin/3</SPAN> 
using the <CODE>html</CODE> tag and thus is present in any document that 
opens the outer <CODE>html</CODE> environment through this library.
</DD>
</DL>

<H4><A NAME="sec:3.12.3"><SPAN class="sec-nr">3.12.3</SPAN> <SPAN class="sec-title">Adding 
rules for html//1</SPAN></A></H4>

<P>In some cases it is practical to extend the translations imposed by 
html//1. When using XPCE for example, it is comfortable to be able 
defining default translation to HTML for objects. We also used this 
technique to define translation rules for the output of the SWI-Prolog
<CODE>library(sgml)</CODE> package.

<P>The html//1 non-terminal first calls the multifile ruleset 
html_write:expand//1.

<DL>
<DT class="pubdef"><A NAME="html_write:expand/1"><STRONG>html_write:expand</STRONG>(<VAR>+Spec</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Hook to add additional translation rules for html//1.</DD>
<DT class="pubdef"><A NAME="html_quoted/1"><STRONG>html_quoted</STRONG>(<VAR>+Atom</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Emit the text in <VAR>Atom</VAR>, inserting entity-references for the 
SGML special characters <CODE>&lt;&amp;&gt;</CODE>.</DD>
<DT class="pubdef"><A NAME="html_quoted_attribute/1"><STRONG>html_quoted_attribute</STRONG>(<VAR>+Atom</VAR>)</A><CODE>//</CODE></DT>
<DD class="defbody">
Emit the text in <VAR>Atom</VAR> suitable for use as an SGML attribute, 
inserting entity-references for the SGML special characters <CODE>&lt;&amp;&gt;"</CODE>.
</DD>
</DL>

<H4><A NAME="sec:3.12.4"><SPAN class="sec-nr">3.12.4</SPAN> <SPAN class="sec-title">Generating 
layout</SPAN></A></H4>

<A NAME="sec:htmllayout"></A>

<P>Though not strictly necessary, the library attempts to generate 
reasonable layout in SGML output. It does this only by inserting 
newlines before and after tags. It does this on the basis of the 
multifile predicate html_write:layout/3

<DL>
<DT class="pubdef"><A NAME="html_write:layout/3"><STRONG>html_write:layout</STRONG>(<VAR>+Tag, 
-Open, -Close</VAR>)</A></DT>
<DD class="defbody">
Specify the layout conventions for the element <VAR>Tag</VAR>, which is 
a lowercase atom. <VAR>Open</VAR> is a term <VAR>Pre</VAR>-<VAR>Post</VAR>. 
It defines that the element should have at least <VAR>Pre</VAR> newline 
characters before and <VAR>Post</VAR> after the tag. The <VAR>Close</VAR> 
specification is similar, but in addition allows for the atom <CODE>-</CODE>, 
requesting the output generator to omit the close-tag altogether or <CODE>empty</CODE>, 
telling the library that the element has declared empty content. In this 
case the close-tag is not emitted either, but in addition html//1 
interprets <VAR>Arg</VAR> in <CODE>Tag(Arg)</CODE> as a list of 
attributes rather than the content.

<P>A tag that does not appear in this table is emitted without 
additional layout. See also <A NAME="idx:printhtml12:91"></A><A class="pred" href="#print_html/1">print_html/[1,2]</A>. 
Please consult the library source for examples.
</DD>
</DL>

<H4><A NAME="sec:3.12.5"><SPAN class="sec-nr">3.12.5</SPAN> <SPAN class="sec-title">Examples</SPAN></A></H4>

<P>In the following example we will generate a table of Prolog 
predicates we find from the SWI-Prolog help system based on a keyword. 
The primary database is defined by the predicate <A NAME="idx:predicate5:92"></A><SPAN class="pred-ext">predicate/5</SPAN> 
We will make hyperlinks for the predicates pointing to their 
documentation.

<PRE class="code">
html_apropos(Kwd) :-
        findall(Pred, apropos_predicate(Kwd, Pred), Matches),
        phrase(apropos_page(Kwd, Matches), Tokens),
        print_html(Tokens).

%       emit page with title, header and table of matches

apropos_page(Kwd, Matches) --&gt;
        page([ title(['Predicates for ', Kwd])
             ],
             [ h2(align(center),
                  ['Predicates for ', Kwd]),
               table([ align(center),
                       border(1),
                       width('80%')
                     ],
                     [ tr([ th('Predicate'),
                            th('Summary')
                          ])
                     | \apropos_rows(Matches)
                     ])
             ]).

%       emit the rows for the body of the table.

apropos_rows([]) --&gt;
        [].
apropos_rows([pred(Name, Arity, Summary)|T]) --&gt;
        html([ tr([ td(\predref(Name/Arity)),
                    td(em(Summary))
                  ])
             ]),
        apropos_rows(T).

%       predref(Name/Arity)
%
%       Emit Name/Arity as a hyperlink to
%
%               /cgi-bin/plman?name=Name&amp;arity=Arity
%
%       we must do form-encoding for the name as it may contain illegal
%       characters.  www_form_encode/2 is defined in library(url).

predref(Name/Arity) --&gt;
        { www_form_encode(Name, Encoded),
          sformat(Href, '/cgi-bin/plman?name=~w&amp;arity=~w',
                  [Encoded, Arity])
        },
        html(a(href(Href), [Name, /, Arity])).

%       Find predicates from a keyword. '$apropos_match' is an internal
%       undocumented predicate.

apropos_predicate(Pattern, pred(Name, Arity, Summary)) :-
        predicate(Name, Arity, Summary, _, _),
        (   '$apropos_match'(Pattern, Name)
        -&gt;  true
        ;   '$apropos_match'(Pattern, Summary)
        ).
</PRE>

<H4><A NAME="sec:3.12.6"><SPAN class="sec-nr">3.12.6</SPAN> <SPAN class="sec-title">Remarks 
on the <CODE>library(http/html_write)</CODE> library</SPAN></A></H4>

<P>This library is the result of various attempts to reach at a more 
satisfactory and Prolog-minded way to produce HTML text from a program. 
We have been using Prolog for the generation of web pages in a number of 
projects. Just using <A NAME="idx:format2:93"></A><SPAN class="pred-ext">format/2</SPAN> 
never was a real option, generating error-prone HTML from clumsy syntax. 
We started with a layer on top of <A NAME="idx:format2:94"></A><SPAN class="pred-ext">format/2</SPAN>, 
keeping track of the current nesting and thus always capable of properly 
closing the environment.

<P>DCG based translation however naturally exploits Prolog's 
term-rewriting primitives. If generation fails for whatever reason it is 
easy to produce an alternative document (for example holding an error 
message).

<P>The approach presented in this library has been used in combination 
with
<CODE>library(http/httpd)</CODE> in three projects: viewing RDF in a 
browser, selecting fragments from an analysed document and presenting 
parts of the XPCE documentation using a browser. It has proven to be 
able to deal with generating pages quickly and comfortably.

<P>In a future version we will probably define a <A NAME="idx:goalexpansion2:95"></A><SPAN class="pred-ext">goal_expansion/2</SPAN> 
to do compile-time optimisation of the library. Quotation of known text 
and invocation of sub-rules using the <CODE>\</CODE><VAR>RuleSet</VAR> 
and
&lt;<VAR>Module</VAR>&gt;:&lt;<VAR>RuleSet</VAR>&gt; operators are 
costly operations in the analysis that can be done at compile-time.

<H3><A NAME="sec:3.13"><SPAN class="sec-nr">3.13</SPAN> <SPAN class="sec-title">http_path.pl 
-- Abstract specification of HTTP server locations</SPAN></A></H3>

<P><A NAME="sec:httppath"></A>

<DL>
<DT><B>To be done</B><DD>- Make this module replace the http:prefix 
option. <BR>
- Remove hard-wired support for prefix().
</DL>

<P>This module provides an abstract specification of HTTP server 
locations that is inspired on <SPAN class="pred-ext">absolute_file_name/3</SPAN>. 
The specification is done by adding rules to the dynamic multifile 
predicate http:<SPAN class="pred-ext">location/3</SPAN>. The 
speficiation is very similar to user:<SPAN class="pred-ext">file_search_path/2</SPAN>, 
but takes an additional argument with options. Currently only one option 
is defined:

<DL>
<DT><STRONG>priority</STRONG>(<VAR>+Integer</VAR>)</DT>
<DD class="defbody">
If two rules match, take the one with highest priority. Using priorities 
is needed because we want to be able to overrule paths, but we do not 
want to become dependent on clause ordering.
</DD>
</DL>

<P>Here is an example that binds <CODE>/login</CODE> to <SPAN class="pred-ext">login/1</SPAN>. 
The user can reuse this application while moving all locations using a 
new rule for the admin location with the option <CODE>[priority(10)]</CODE>.

<PRE class="code">
:- multifile http:location/3.
:- dynamic   http:location/3.

http:location(admin, /, []).

:- http_handler(admin(login), login, []).

login(Request) :-
        ...
</PRE>

<DL>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="http_absolute_location/3"><STRONG>http_absolute_location</STRONG>(<VAR>+Spec, 
-Path, +Options</VAR>)</A></DT>
<DD class="defbody">
<VAR>Path</VAR> is the HTTP location for the abstract specification <VAR>Spec</VAR>.
<VAR>Options</VAR>:

<DL>
<DT><STRONG>relative_to</STRONG>(<VAR>Base</VAR>)</DT>
<DD class="defbody">
<VAR>Path</VAR> is made relative to Base. Default is to generate 
absolute URLs.
</DD>
</DL>

</DD>
</DL>

<H3><A NAME="sec:3.14"><SPAN class="sec-nr">3.14</SPAN> <SPAN class="sec-title">Security</SPAN></A></H3>

<P>Writing servers is an inherently dangerous job that should be carried 
out with some considerations. You have basically started a program on a 
public terminal and invited strangers to use it. When using the 
interactive server or inetd based server the server runs under your 
privileges. Using CGI scripted it runs with the privileges of your 
web-server. Though it should not be possible to fatally compromise a 
Unix machine using user privileges, getting unconstrained access to the 
system is highly undesirable.

<P>Symbolic languages have an additional handicap in their inherent 
possibilities to modify the running program and dynamically create goals 
(this also applies to the popular perl and java scripting languages). 
Here are some guidelines.

<P>
<UL>
<LI><I>Check your input</I><BR>
Hardly anything can go wrong if you check the validity of 
query-arguments before formulating an answer.

<P>
<LI><I>Check filenames</I><BR>
If part of the query consists of filenames or directories, check them. 
This also applies to files you only read. Passing names as
<CODE>/etc/passwd</CODE>, but also <CODE>../../../../../etc/passwd</CODE> 
are tried by experienced hackers to learn about the system they want to 
attack. So, expand provided names using <A NAME="idx:absolutefilename23:96"></A><SPAN class="pred-ext">absolute_file_name/[2,3]</SPAN> 
and verify they are inside a folder reserved for the server. Avoid 
symbolic links from this subtree to the outside world. The example below 
checks validity of filenames. The first call ensures proper canonisation 
of the paths to avoid an mismatch due to symbolic links or other 
filesystem ambiguities.

<PRE class="code">
check_file(File) :-
        absolute_file_name('/path/to/reserved/area', Reserved),
        absolute_file_name(File, Tried),
        atom_concat(Reserved, _, Tried).
</PRE>

<P>
<LI><I>Check scripts</I><BR>
Should input in any way activate external scripts using <A NAME="idx:shell1:97"></A><SPAN class="pred-ext">shell/1</SPAN> 
or <CODE>open(pipe(Command), ...)</CODE>, verify the argument once more.

<P>
<LI><I>Check meta-calling</I><BR>
<EM>The</EM> attractive situation for you and your attacker is below:

<PRE class="code">
reply(Query) :-
        member(search(Args), Query),
        member(action=Action, Query),
        member(arg=Arg, Query),
        call(Action, Arg).              % NEVER EVER DO THIS!
</PRE>

<P>All your attacker has to do is specify <VAR>Action</VAR> as <CODE>shell</CODE> 
and <VAR>Arg</VAR> as <CODE>/bin/sh</CODE> and he has an uncontrolled 
shell!
</UL>

<H3><A NAME="sec:3.15"><SPAN class="sec-nr">3.15</SPAN> <SPAN class="sec-title">Tips 
and tricks</SPAN></A></H3>

<P>
<UL>
<LI><I>URL Locations</I><BR>
With an application in mind, it is tempting to make all URL locations 
short and directly connected to the root (<CODE>/</CODE>). This is
<EM>not</EM> a good idea. It is adviced to have all locations in a 
server below a directory with an informative name. Consider to make the 
root location something that can be changed using a global setting.

<P>
<UL>
<LI>Page generating code can easily be reused. Using locations directly 
below the root however increases the likelihood of conflicts.
<LI>Multiple servers can be placed behind the same public server as 
explained in <A class="sec" href="#sec:3.7.7">section 3.7.7</A>. Using a 
common and fairly unique root, redirection is much easier and less 
likely to lead to conflicts.
</UL>

<P>
<LI><I>Debugging</I><BR>
Please check the section <A class="url" href="http://gollem.science.uva.nl/SWI-Prolog/Manual/thutil.html">``Thread-support 
library(threadutil)''</A> of the SWI-Prolog reference manual.
</UL>

<H2><A NAME="sec:4"><SPAN class="sec-nr">4</SPAN> <SPAN class="sec-title">Transfer 
encodings</SPAN></A></H2>

<A NAME="sec:transfer"></A>

<P><A NAME="idx:chunkedencoding:98"></A><A NAME="idx:deflateencoding:99"></A>The 
HTTP protocol provides for <EM>transfer encodings</EM>. These define 
filters applied to the data described by the <CODE>Content-type</CODE>. 
The two most popular transfer encodings are <CODE>chunked</CODE> and
<CODE>deflate</CODE>. The <CODE>chunked</CODE> encoding avoids the need 
for a <CODE>Content-length</CODE> header, sending the data in chunks, 
each of which is preceded by a length. The <CODE>deflate</CODE> encoding 
provides compression.

<P>Transfer-encodings are supported by filters defined as foreign 
libraries that realise an encoding/decoding stream on top of another 
stream. Currently there are two such libraries: <CODE>library(http/http_chunked.pl)</CODE> 
and <CODE>library(zlib.pl)</CODE>.

<P>There is an emerging hook interface dealing with transfer encodings. 
The
<CODE>library(http/http_chunked.pl)</CODE> provides a hook used by
<CODE>library(http/http_open.pl)</CODE> to support chunked encoding in <A NAME="idx:httpopen3:100"></A><A class="pred" href="#http_open/3">http_open/3</A>. 
Note that both <CODE>http_open.pl</CODE> <EM>and</EM> <CODE>http_chunked.pl</CODE> 
must be loaded for <A NAME="idx:httpopen3:101"></A><A class="pred" href="#http_open/3">http_open/3</A> 
to support chunked encoding.

<H3><A NAME="sec:4.1"><SPAN class="sec-nr">4.1</SPAN> <SPAN class="sec-title">The <CODE>library(http/http_chunked)</CODE> 
library</SPAN></A></H3>

<DL>
<DT class="pubdef"><A NAME="http_chunked_open/3"><STRONG>http_chunked_open</STRONG>(<VAR>+RawStream, 
-DataStream, +Options</VAR>)</A></DT>
<DD class="defbody">
Create a stream to realise HTTP chunked encoding or decoding. The 
technique is similar to library(zlib), using a Prolog stream as a filter 
on another stream. See online documentation at
<A class="url" href="http://gollem.science.uva.nl/SWI-Prolog/pldoc/">http://gollem.science.uva.nl/SWI-Prolog/pldoc/</A> 
for details.
</DD>
</DL>

<H2><A NAME="sec:5"><SPAN class="sec-nr">5</SPAN> <SPAN class="sec-title">Supporting 
JSON</SPAN></A></H2>

<P><A NAME="sec:json"></A>

<P>From <A class="url" href="http://json.org,">http://json.org,</A> " 
JSON (JavaScript Object Notation) is a lightweight data-interchange 
format. It is easy for humans to read and write. It is easy for machines 
to parse and generate. It is based on a subset of the JavaScript 
Programming Language, Standard ECMA-262 3rd Edition - December 1999. 
JSON is a text format that is completely language independent but uses 
conventions that are familiar to programmers of the C-family of 
languages, including C, C++, C#, Java, JavaScript, Perl, Python, and 
many others. These properties make JSON an ideal data-interchange 
language."

<P>JSON is interesting to Prolog because using AJAX web technology we 
can easily created web-enabled user interfaces where we implement the 
server side using the SWI-Prolog HTTP services provided by this package. 
The interface consists of three libraries:

<P>
<UL>
<LI>library(http/json) provides support for the core JSON object 
serialization.
<LI>library(http/json_convert) converts between the primary 
representation of JSON terms in Prolog and more application oriented 
Prolog terms. E.g. point(X,Y) vs. object([x=X,y=Y]).
<LI>library(http/http_json) hooks the conversion libraries into the HTTP 
client and server libraries.
</UL>

<H3><A NAME="sec:5.1"><SPAN class="sec-nr">5.1</SPAN> <SPAN class="sec-title">json.pl 
-- Reading and writing JSON serialization</SPAN></A></H3>

<P><A NAME="sec:json"></A>

<DL>
<DT><B>author</B><DD> Jan Wielemaker<DT><B>See also</B><DD>- <CODE>http_json.pl</CODE> 
links JSON to the HTTP client and server modules. <BR>
- <CODE>json_convert.pl</CODE> converts JSON Prolog terms to more 
comfortable terms.
</DL>

<P>This module supports reading and writing JSON objects. The canonical 
Prolog representation for a JSON value is defined as:

<P>
<UL>
<LI>A JSON object is mapped to a term json(NameValueList), where 
NameValueList is a list of Name=Value. Name is an atom created from the 
JSON string.
<LI>A JSON array is mapped to a Prolog list of JSON values.
<LI>A JSON string is mapped to a Prolog atom
<LI>A JSON number is mapped to a Prolog number
<LI>The JSON constants <CODE>true</CODE> and <CODE>false</CODE> are 
mapped -like JPL- to @(true) and @(false).
<LI>The JSON constant <CODE>null</CODE> is mapped to the Prolog term 
@(null)
</UL>

<P>Here is a complete example in JSON and its corresponding Prolog term.

<PRE class="code">
{ "name":"Demo term",
  "created": {
    "day":null,
    "month":"December",
    "year":2007
  },
  "confirmed":true,
  "members":[1,2,3]
}
</PRE>

<PRE class="code">
json([ name='Demo term',
       created=json([day= @null, month='December', year=2007]),
       confirmed= @true,
       members=[1, 2, 3]
     ])
</PRE>

<DL>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="atom_json_term/3"><STRONG>atom_json_term</STRONG>(<VAR>+Atom, 
-JSONTerm, +Options</VAR>)</A></DT>
<DD class="defbody">
</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="atom_json_term/3"><STRONG>atom_json_term</STRONG>(<VAR>-Text, 
+JSONTerm, +Options</VAR>)</A></DT>
<DD class="defbody">
Convert between textual representation and a JSON term. In
<I>write</I> mode, the option as(Type) defines the output type, which is 
one of <CODE>atom</CODE>, <CODE>string</CODE> or <CODE>codes</CODE>.</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="json_read/2"><STRONG>json_read</STRONG>(<VAR>+Stream, 
-Term</VAR>)</A></DT>
<DD class="defbody">
</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="json_read/3"><STRONG>json_read</STRONG>(<VAR>+Stream, 
-Term, +Options</VAR>)</A></DT>
<DD class="defbody">
Read next JSON value from <VAR>Stream</VAR> into a Prolog term. <VAR>Options</VAR> 
are:

<DL>
<DT><STRONG>null</STRONG>(<VAR>NullTerm</VAR>)</DT>
<DD class="defbody">
<VAR>Term</VAR> used to represent JSON <CODE>null</CODE>. Default 
@(null)
</DD>
<DT><STRONG>true</STRONG>(<VAR>TrueTerm</VAR>)</DT>
<DD class="defbody">
<VAR>Term</VAR> used to represent JSON <CODE>true</CODE>. Default 
@(true)
</DD>
<DT><STRONG>false</STRONG>(<VAR>FalsTerm</VAR>)</DT>
<DD class="defbody">
<VAR>Term</VAR> used to represent JSON <CODE>false</CODE>. Default 
@(false)
</DD>
<DT><STRONG>value_string_as</STRONG>(<VAR>Type</VAR>)</DT>
<DD class="defbody">
Prolog type used for strings used as value. Default is <CODE>atom</CODE>. 
The alternative is <CODE>string</CODE>, producing a packed string 
object. Please note that <CODE>codes</CODE> or
<CODE>chars</CODE> would produce ambiguous output and is therefore not 
supported.
</DD>
</DL>

</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="json_write/2"><STRONG>json_write</STRONG>(<VAR>+Stream, 
+Term</VAR>)</A></DT>
<DD class="defbody">
</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="json_write/3"><STRONG>json_write</STRONG>(<VAR>+Stream, 
+Term, +Options</VAR>)</A></DT>
<DD class="defbody">
Write a JSON term to <VAR>Stream</VAR>. The JSON object is of the same 
format as produced by <A class="pred" href="#json_read/2">json_read/2</A>, 
though we allow for some more flexibility with regard to pairs in 
objects. All of Name=Value, Name-Value and Name(Value) produce the same 
output. In addition to the options recognised by <A class="pred" href="#json_read/3">json_read/3</A>, 
we process the following options are recognised:

<DL>
<DT><STRONG>width</STRONG>(<VAR>+Width</VAR>)</DT>
<DD class="defbody">
Width in which we try to format the result. Too long lines switch from <I>horizontal</I> 
to <I>vertical</I> layout for better readability. If performance is 
critical and human readability is not an issue use Width = 0, which 
causes a single-line output.
</DD>
<DT><STRONG>step</STRONG>(<VAR>+Step</VAR>)</DT>
<DD class="defbody">
Indentation increnment for next level. Default is 2.
</DD>
<DT><STRONG>tab</STRONG>(<VAR>+TabDistance</VAR>)</DT>
<DD class="defbody">
Distance between tab-stops. If equal to Step, layout is generated with 
one tab per level.
</DD>
</DL>

</DD>
<DT class="pubdef"><span class="pred-tag">[semidet]</span><A NAME="is_json_term/1"><STRONG>is_json_term</STRONG>(<VAR>@Term</VAR>)</A></DT>
<DD class="defbody">
</DD>
<DT class="pubdef"><span class="pred-tag">[semidet]</span><A NAME="is_json_term/2"><STRONG>is_json_term</STRONG>(<VAR>@Term, 
+Options</VAR>)</A></DT>
<DD class="defbody">
True if <VAR>Term</VAR> is a json term. <VAR>Options</VAR> are the same 
as for
<A class="pred" href="#json_read/2">json_read/2</A>, defining the Prolog 
representation for the JSON
<CODE>true</CODE>, <CODE>false</CODE> and <CODE>null</CODE> constants.
</DD>
</DL>

<H3><A NAME="sec:5.2"><SPAN class="sec-nr">5.2</SPAN> <SPAN class="sec-title">json_convert.pl 
-- Convert between JSON terms and Prolog application terms</SPAN></A></H3>

<P><A NAME="sec:jsonconvert"></A>

<DL>
<DT><B>To be done</B><DD>- Ignore extra fields. Using a partial list of <I>extra</I>? <BR>
- Consider a sensible default for handling JSON <CODE>null</CODE>. 
Conversion to Prolog could translate @null into a variable if the 
desired type is not <CODE>any</CODE>. Conversion to JSON could map 
variables to <CODE>null</CODE>, though this may be unsafe. If the Prolog 
term is known to be non-ground and JSON @null is a sensible mapping, we 
can also use this simple snipit to deal with that fact.

<PRE class="code">
        term_variables(Term, Vars),
        maplist(=(@null), Vars).
</PRE>

</DL>

<P>The idea behind this module is to provide a flexible high-level 
mapping between Prolog terms as you would like to see them in your 
application and the standard representation of a JSON object as a Prolog 
term. For example, an X-Y point may be represented in JSON as <CODE>{"x":25, "y":50}</CODE>. 
Represented in Prolog this becomes json([x=25,y=50]), but this is a 
pretty non-natural representation from the Prolog point of view.

<P>This module allows for defining records (just like library(record)) 
that provide transparent two-way transformation between the two 
representations.

<PRE class="code">
:- json_object
        point(x:integer, y:integer).
</PRE>

<P>This declaration causes <A class="pred" href="#prolog_to_json/2">prolog_to_json/2</A> 
to translate the native Prolog representation into a JSON Term:

<PRE class="code">
?- prolog_to_json(point(25,50), X).

X = json([x=25, y=50])
</PRE>

<P>A <A class="pred" href="#json_object/1">json_object/1</A> declaration 
can define multiple objects separated by a comma (,), similar to the <SPAN class="pred-ext">dynamic/1</SPAN> 
directive. Optionally, a declaration can be qualified using a module. 
The converstion predicates
<A class="pred" href="#prolog_to_json/2">prolog_to_json/2</A> and <A class="pred" href="#json_to_prolog/2">json_to_prolog/2</A> 
first try a conversion associated with the calling module. If not 
successful, they try conversions associated with the module <CODE>user</CODE>.

<P>JSON objects have no <I>type</I>. This can be solved by adding an 
extra field to the JSON object, e.g. <CODE>{"type":"point", "x":25, "y":50}</CODE>. 
As Prolog records are typed by their functor we need some notation to 
handle this gracefully. This is achieved by adding +Fields to the 
declaration. I.e.

<PRE class="code">
:- json_object
        point(x:integer, y:integer) + [type=point].
</PRE>

<P>Using this declaration, the conversion becomes:

<PRE class="code">
?- prolog_to_json(point(25,50), X).

X = json([x=25, y=50, type=point])
</PRE>

<P>The predicate <A class="pred" href="#json_to_prolog/2">json_to_prolog/2</A> 
is often used after <A class="pred" href="#http_read_json/2">http_read_json/2</A> 
and
<A class="pred" href="#prolog_to_json/2">prolog_to_json/2</A> before <A class="pred" href="#reply_json/1">reply_json/1</A>. 
For now we consider them seperate predicates because the transformation 
may be too general, too slow or not needed for dedicated applications. 
Using a seperate step also simplifies debugging this rather complicated 
process.

<DL>
<DT class="pubdef"><A NAME="json_object/1"><STRONG>json_object</STRONG> <VAR>+Declaration</VAR></A></DT>
<DD class="defbody">
Declare a JSON object. The declaration takes the same format as using in <SPAN class="pred-ext">record/1</SPAN> 
from library(record). E.g.

<PRE class="code">
?- json_object
        point(x:int, y:int, z:int=0).
</PRE>

</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="prolog_to_json/2"><STRONG>prolog_to_json</STRONG>(<VAR>:Term, 
-JSONObject</VAR>)</A></DT>
<DD class="defbody">
Translate a Prolog application <VAR>Term</VAR> into a JSON object term. 
This transformation is based on <CODE>:-</CODE> <A class="pred" href="#json_object/1">json_object/1</A> 
declarations. If a <A class="pred" href="#json_object/1">json_object/1</A> 
declaration declares a field of type
<CODE>boolean</CODE>, commonly used thruth-values in Prolog are 
converted to JSON booleans. Boolean translation accepts one of <CODE>true</CODE>,
<CODE>on</CODE>, <CODE>1</CODE>, @true, <CODE>false</CODE>, <CODE>fail</CODE>, <CODE>off</CODE> 
or <CODE>0</CODE>, @false.

<DL>
<DT><B>Errors</B><DD>- type_error(json_term, X) <BR>
- instantiation_error
</DL>

</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="json_to_prolog/2"><STRONG>json_to_prolog</STRONG>(<VAR>+JSON, 
-Term</VAR>)</A></DT>
<DD class="defbody">
Translate a <VAR>JSON</VAR> term into an application term. This 
transformation is based on <CODE>:-</CODE> <A class="pred" href="#json_object/1">json_object/1</A> 
declarations. An efficient transformation is non-trivial, but we rely on 
the assumption that, although the order of fields in <VAR>JSON</VAR> 
terms is irrelevant and can therefore vary a lot, practical applications 
will normally generate the <VAR>JSON</VAR> objects in a consistent 
order.

<P>If a field in a json_object is declared of type <CODE>boolean</CODE>, 
@true and @false are translated to <CODE>true</CODE> or <CODE>false</CODE>, 
the most commonly used Prolog representation for truth-values.
</DD>
</DL>

<H3><A NAME="sec:5.3"><SPAN class="sec-nr">5.3</SPAN> <SPAN class="sec-title">http_json.pl 
-- HTTP JSON Plugin module</SPAN></A></H3>

<P><A NAME="sec:httpjson"></A>

<DL>
<DT><B>See also</B><DD>- JSON Requests are discussed in <A class="url" href="http://json.org/JSONRequest.html">http://json.org/JSONRequest.html</A> <BR>
- <CODE>json.pl</CODE> describes how JSON objects are represented in 
Prolog terms. <BR>
- <CODE>json_convert.pl</CODE> converts between more natural Prolog 
terms and json terms.
</DL>

<P>This module inserts the JSON parser for documents of MIME type
<CODE>application/jsonrequest</CODE> and <CODE>application/json</CODE> 
requested through the <CODE>http_client.pl</CODE> library.

<P>Typically JSON is used by Prolog HTTP servers. Below is a skeleton 
for handling a JSON request, answering in JSON.

<PRE class="code">
handle(Request) :-
        http_read_json(Request, JSONIn),
        json_to_prolog(JSONIn, PrologIn),
        &lt;compute&gt;(PrologIn, PrologOut),		% application body
        prolog_to_json(PrologOut, JSONOut),
        reply_json(JSONOut).
</PRE>

<P>This module also integrates JSON support into the http client 
provided by <CODE>http_client.pl</CODE>. Posting a JSON query and 
processing the JSON reply (or any other reply understood by <A class="pred" href="#http_read_data/3">http_read_data/3</A>) 
is as simple as below, where Term is a JSON term as described in <CODE>json.pl</CODE> 
and reply is of the same format if the server replies with JSON.

<PRE class="code">
        ...,
        http_post(URL, json(Term), Reply, [])
</PRE>

<DL>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="http_read_json/2"><STRONG>http_read_json</STRONG>(<VAR>+Request, 
-JSON</VAR>)</A></DT>
<DD class="defbody">
</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="http_read_json/3"><STRONG>http_read_json</STRONG>(<VAR>+Request, 
-JSON, +Options</VAR>)</A></DT>
<DD class="defbody">
Extract <VAR>JSON</VAR> data posted to this HTTP request.

<DL>
<DT><B>Errors</B><DD>- domain_error(mimetype, Found) if the mimetype is 
not known (see <SPAN class="pred-ext">json_type/1</SPAN>). <BR>
- domain_error(method, Method) if the request is not a POST request.
</DL>

</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="reply_json/1"><STRONG>reply_json</STRONG>(<VAR>+JSONTerm</VAR>)</A></DT>
<DD class="defbody">
</DD>
<DT class="pubdef"><span class="pred-tag">[det]</span><A NAME="reply_json/2"><STRONG>reply_json</STRONG>(<VAR>+JSONTerm, 
+Options</VAR>)</A></DT>
<DD class="defbody">
Formulate a JSON HTTP reply. See <A class="pred" href="#json_write/2">json_write/2</A> 
for details.
<VAR>Options</VAR> accepts content_type(+Type) and options accepted by
<A class="pred" href="#json_write/3">json_write/3</A>.
</DD>
</DL>

<H2><A NAME="sec:6"><SPAN class="sec-nr">6</SPAN> <SPAN class="sec-title">Status</SPAN></A></H2>

<P>The SWI-Prolog HTTP library is in active use in a large number of 
projects. It is considered one of the SWI-Prolog core libraries that is 
actively maintained and regularly extended with new features. This is 
particularly true for the multi-threaded server. The XPCE and inetd 
based servers are not widely used.

<P>This library is by no means complete and you are free to extend it.

<H1><A NAME="document-index">Index</A></H1>

<DL>
<DT><STRONG>A</STRONG></DT>
<DD>
</DD>
<DT>absolute_file_name/3</DT>
<DD>
<A class="idx" href="#idx:absolutefilename3:45">3.2</A></DD>
<DT>absolute_file_name/[2,3]</DT>
<DD>
<A class="idx" href="#idx:absolutefilename23:96">3.14</A></DD>
<DT><A class="idx" href="#atom_json_term/3">atom_json_term/3</A></DT>
<DD>
</DD>
<DT><STRONG>C</STRONG></DT>
<DD>
</DD>
<DT>chunked,encoding</DT>
<DD>
<A class="idx" href="#idx:chunkedencoding:98">4</A></DD>
<DT>close/1</DT>
<DD>
<A class="idx" href="#idx:close1:2">2.1</A></DD>
<DT>crypt/2</DT>
<DD>
<A class="idx" href="#idx:crypt2:48">3.4</A></DD>
<DT><STRONG>D</STRONG></DT>
<DD>
</DD>
<DT>deflate,encoding</DT>
<DD>
<A class="idx" href="#idx:deflateencoding:99">4</A></DD>
<DT><STRONG>E</STRONG></DT>
<DD>
</DD>
<DT>edit/1</DT>
<DD>
<A class="idx" href="#idx:edit1:31">3.2</A></DD>
<DT><STRONG>F</STRONG></DT>
<DD>
</DD>
<DT>file_mime_type/2</DT>
<DD>
<A class="idx" href="#idx:filemimetype2:19">2.2</A></DD>
<DT>file_search_path/2</DT>
<DD>
<A class="idx" href="#idx:filesearchpath2:46">3.2</A></DD>
<DT>format/2</DT>
<DD>
<A class="idx" href="#idx:format2:79">3.12</A> <A class="idx" href="#idx:format2:93">3.12.6</A> <A class="idx" href="#idx:format2:94">3.12.6</A></DD>
<DT><STRONG>G</STRONG></DT>
<DD>
</DD>
<DT>goal_expansion/2</DT>
<DD>
<A class="idx" href="#idx:goalexpansion2:95">3.12.6</A></DD>
<DT><STRONG>H</STRONG></DT>
<DD>
</DD>
<DT><A class="idx" href="#html/1">html/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_begin/1">html_begin/1</A></DT>
<DD>
<A class="idx" href="#idx:htmlbegin1:89">3.12</A></DD>
<DT><A class="idx" href="#html_end/1">html_end/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_post/2">html_post/2</A></DT>
<DD>
</DD>
<DT>html_print/[1,2]</DT>
<DD>
<A class="idx" href="#idx:htmlprint12:90">3.12.1</A></DD>
<DT><A class="idx" href="#html_print_length/2">html_print_length/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_quoted/1">html_quoted/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_quoted_attribute/1">html_quoted_attribute/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_receive/1">html_receive/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_receive/2">html_receive/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_write:expand/1">html_write:expand/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#html_write:layout/3">html_write:layout/3</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_absolute_location/3">http_absolute_location/3</A></DT>
<DD>
</DD>
<DT>http_authenticate/3</DT>
<DD>
<A class="idx" href="#idx:httpauthenticate3:49">3.4</A></DD>
<DT><A class="idx" href="#http_authenticate/+Type, +Request, -User">http_authenticate/+Type, 
+Request, -User</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_chunked_open/3">http_chunked_open/3</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_current_handler/2">http_current_handler/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_current_request/1">http_current_request/1</A></DT>
<DD>
<A class="idx" href="#idx:httpcurrentrequest1:75">3.8</A></DD>
<DT><A class="idx" href="#http_current_server/2">http_current_server/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_current_session/2">http_current_session/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_current_worker/2">http_current_worker/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_delete_handler/1">http_delete_handler/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_dispatch/1">http_dispatch/1</A></DT>
<DD>
<A class="idx" href="#idx:httpdispatch1:33">3.2</A> <A class="idx" href="#idx:httpdispatch1:35">3.2</A></DD>
<DT><A class="idx" href="#http_get/3">http_get/3</A></DT>
<DD>
<A class="idx" href="#idx:httpget3:7">2.1</A> <A class="idx" href="#idx:httpget3:15">2.2</A> <A class="idx" href="#idx:httpget3:17">2.2</A></DD>
<DT><A class="idx" href="#http_handler/3">http_handler/3</A></DT>
<DD>
<A class="idx" href="#idx:httphandler3:26">3.1</A> <A class="idx" href="#idx:httphandler3:32">3.2</A> <A class="idx" href="#idx:httphandler3:41">3.2</A> <A class="idx" href="#idx:httphandler3:44">3.2</A> <A class="idx" href="#idx:httphandler3:50">3.4</A> <A class="idx" href="#idx:httphandler3:66">3.7.2</A> <A class="idx" href="#idx:httphandler3:86">3.12</A></DD>
<DT><A class="idx" href="#http_location_by_id/2">http_location_by_id/2</A></DT>
<DD>
<A class="idx" href="#idx:httplocationbyid2:36">3.2</A> <A class="idx" href="#idx:httplocationbyid2:84">3.12</A></DD>
<DT><A class="idx" href="#http_log/2">http_log/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_log_stream/1">http_log_stream/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_open/3">http_open/3</A></DT>
<DD>
<A class="idx" href="#idx:httpopen3:6">2.1</A> <A class="idx" href="#idx:httpopen3:9">2.1</A> <A class="idx" href="#idx:httpopen3:10">2.1</A> <A class="idx" href="#idx:httpopen3:100">4</A> <A class="idx" href="#idx:httpopen3:101">4</A></DD>
<DT><A class="idx" href="#http_parameters/2">http_parameters/2</A></DT>
<DD>
<A class="idx" href="#idx:httpparameters2:52">3.5</A></DD>
<DT><A class="idx" href="#http_parameters/3">http_parameters/3</A></DT>
<DD>
<A class="idx" href="#idx:httpparameters3:53">3.5</A></DD>
<DT><A class="idx" href="#http_post/4">http_post/4</A></DT>
<DD>
<A class="idx" href="#idx:httppost4:8">2.1</A> <A class="idx" href="#idx:httppost4:18">2.2</A></DD>
<DT><A class="idx" href="#http_post_data/3">http_post_data/3</A></DT>
<DD>
<A class="idx" href="#idx:httppostdata3:16">2.2</A></DD>
<DT><A class="idx" href="#http_read_data/3">http_read_data/3</A></DT>
<DD>
<A class="idx" href="#idx:httpreaddata3:11">2.2</A> <A class="idx" href="#idx:httpreaddata3:14">2.2</A> <A class="idx" href="#idx:httpreaddata3:56">3.6.1</A></DD>
<DT><A class="idx" href="#http_read_json/2">http_read_json/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_read_json/3">http_read_json/3</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_read_request/2">http_read_request/2</A></DT>
<DD>
<A class="idx" href="#idx:httpreadrequest2:13">2.2</A> <A class="idx" href="#idx:httpreadrequest2:54">3.6</A> <A class="idx" href="#idx:httpreadrequest2:55">3.6</A></DD>
<DT><A class="idx" href="#http_relative_path/2">http_relative_path/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_reply/3">http_reply/3</A></DT>
<DD>
<A class="idx" href="#idx:httpreply3:28">3.1.1</A> <A class="idx" href="#idx:httpreply3:29">3.1.1</A> <A class="idx" href="#idx:httpreply3:76">3.11</A></DD>
<DT><A class="idx" href="#http_reply_file/3">http_reply_file/3</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http:request_expansion/2">http:request_expansion/2</A></DT>
<DD>
</DD>
<DT>http_server/1</DT>
<DD>
<A class="idx" href="#idx:httpserver1:69">3.7.4</A></DD>
<DT><A class="idx" href="#http_server/2">http_server/2</A></DT>
<DD>
<A class="idx" href="#idx:httpserver2:34">3.2</A></DD>
<DT><A class="idx" href="#http_server/3">http_server/3</A></DT>
<DD>
<A class="idx" href="#idx:httpserver3:61">3.7.2</A></DD>
<DT><A class="idx" href="#http_session_assert/1">http_session_assert/1</A></DT>
<DD>
<A class="idx" href="#idx:httpsessionassert1:47">3.3</A></DD>
<DT><A class="idx" href="#http_session_asserta/1">http_session_asserta/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_session_data/1">http_session_data/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_session_id/1">http_session_id/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_session_retract/1">http_session_retract/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_session_retractall/1">http_session_retractall/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_set_authorization/2">http_set_authorization/2</A></DT>
<DD>
<A class="idx" href="#idx:httpsetauthorization2:3">2.1</A></DD>
<DT><A class="idx" href="#http_set_session_options/1">http_set_session_options/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_spawn/2">http_spawn/2</A></DT>
<DD>
<A class="idx" href="#idx:httpspawn2:40">3.2</A> <A class="idx" href="#idx:httpspawn2:62">3.7.2</A></DD>
<DT><A class="idx" href="#http_stop_server/2">http_stop_server/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#http_workers/2">http_workers/2</A></DT>
<DD>
<A class="idx" href="#idx:httpworkers2:59">3.7.2</A></DD>
<DT><A class="idx" href="#http_wrapper/5">http_wrapper/5</A></DT>
<DD>
<A class="idx" href="#idx:httpwrapper5:25">3.1</A> <A class="idx" href="#idx:httpwrapper5:30">3.2</A> <A class="idx" href="#idx:httpwrapper5:51">3.5</A> <A class="idx" href="#idx:httpwrapper5:68">3.7.3</A> <A class="idx" href="#idx:httpwrapper5:70">3.7.4</A> <A class="idx" href="#idx:httpwrapper5:71">3.8</A> <A class="idx" href="#idx:httpwrapper5:72">3.8</A> <A class="idx" href="#idx:httpwrapper5:74">3.8</A></DD>
<DT><STRONG>I</STRONG></DT>
<DD>
</DD>
<DT>interactive_httpd</DT>
<DD>
<A class="sec" href="#sec:3.7.3">3.7.3</A></DD>
<DT><A class="idx" href="#is_json_term/1">is_json_term/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#is_json_term/2">is_json_term/2</A></DT>
<DD>
</DD>
<DT><STRONG>J</STRONG></DT>
<DD>
</DD>
<DT><A class="idx" href="#json_object/1">json_object/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#json_read/2">json_read/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#json_read/3">json_read/3</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#json_to_prolog/2">json_to_prolog/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#json_write/2">json_write/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#json_write/3">json_write/3</A></DT>
<DD>
</DD>
<DT><STRONG>L</STRONG></DT>
<DD>
</DD>
<DT>load_structure/3</DT>
<DD>
<A class="idx" href="#idx:loadstructure3:22">2.2.2</A> <A class="idx" href="#idx:loadstructure3:23">2.2.2</A> <A class="idx" href="#idx:loadstructure3:24">2.2.2</A></DD>
<DT><STRONG>M</STRONG></DT>
<DD>
</DD>
<DT>make/0</DT>
<DD>
<A class="idx" href="#idx:make0:42">3.2</A></DD>
<DT>mime_pack/3</DT>
<DD>
<A class="idx" href="#idx:mimepack3:20">2.2</A> <A class="idx" href="#idx:mimepack3:21">2.2</A></DD>
<DT><STRONG>P</STRONG></DT>
<DD>
</DD>
<DT><A class="idx" href="#page/1">page/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#page/2">page/2</A></DT>
<DD>
</DD>
<DT>page/[1,2]</DT>
<DD>
<A class="idx" href="#idx:page12:88">3.12</A></DD>
<DT>parse_time/2</DT>
<DD>
<A class="idx" href="#idx:parsetime2:5">2.1</A></DD>
<DT>parse_url/2</DT>
<DD>
<A class="idx" href="#idx:parseurl2:1">2.1</A></DD>
<DT>pp/1</DT>
<DD>
<A class="idx" href="#idx:pp1:57">3.6.1</A></DD>
<DT>predicate/5</DT>
<DD>
<A class="idx" href="#idx:predicate5:92">3.12.5</A></DD>
<DT><A class="idx" href="#print_html/1">print_html/1</A></DT>
<DD>
<A class="idx" href="#idx:printhtml1:77">3.11</A></DD>
<DT><A class="idx" href="#print_html/2">print_html/2</A></DT>
<DD>
</DD>
<DT>print_html/[1,2]</DT>
<DD>
<A class="idx" href="#idx:printhtml12:80">3.12</A> <A class="idx" href="#idx:printhtml12:81">3.12</A> <A class="idx" href="#idx:printhtml12:91">3.12.4</A></DD>
<DT>print_message/2</DT>
<DD>
<A class="idx" href="#idx:printmessage2:78">3.11</A></DD>
<DT><A class="idx" href="#prolog_to_json/2">prolog_to_json/2</A></DT>
<DD>
</DD>
<DT><STRONG>R</STRONG></DT>
<DD>
</DD>
<DT>reply/1</DT>
<DD>
<A class="idx" href="#idx:reply1:67">3.7.3</A></DD>
<DT><A class="idx" href="#reply_html_page/2">reply_html_page/2</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#reply_json/1">reply_json/1</A></DT>
<DD>
</DD>
<DT><A class="idx" href="#reply_json/2">reply_json/2</A></DT>
<DD>
</DD>
<DT><STRONG>S</STRONG></DT>
<DD>
</DD>
<DT>set_lang/1</DT>
<DD>
<A class="idx" href="#idx:setlang1:85">3.12</A> <A class="idx" href="#idx:setlang1:87">3.12</A></DD>
<DT>set_stream/2</DT>
<DD>
<A class="idx" href="#idx:setstream2:4">2.1</A> <A class="idx" href="#idx:setstream2:12">2.2</A></DD>
<DT>setting/2</DT>
<DD>
<A class="idx" href="#idx:setting2:43">3.2</A></DD>
<DT>setting/4</DT>
<DD>
<A class="idx" href="#idx:setting4:37">3.2</A></DD>
<DT>sformat/3</DT>
<DD>
<A class="idx" href="#idx:sformat3:82">3.12</A></DD>
<DT>shell/1</DT>
<DD>
<A class="idx" href="#idx:shell1:97">3.14</A></DD>
<DT>socket</DT>
<DD>
<A class="sec" href="#sec:3.7.3">3.7.3</A></DD>
<DT>ssl_init/3</DT>
<DD>
<A class="idx" href="#idx:sslinit3:60">3.7.2</A></DD>
<DT><STRONG>T</STRONG></DT>
<DD>
</DD>
<DT>tcp_accept/3</DT>
<DD>
<A class="idx" href="#idx:tcpaccept3:73">3.8</A></DD>
<DT>thread_create/3</DT>
<DD>
<A class="idx" href="#idx:threadcreate3:39">3.2</A> <A class="idx" href="#idx:threadcreate3:65">3.7.2</A></DD>
<DT>thread_create_in_pool/4</DT>
<DD>
<A class="idx" href="#idx:threadcreateinpool4:64">3.7.2</A></DD>
<DT>thread_pool_create/3</DT>
<DD>
<A class="idx" href="#idx:threadpoolcreate3:38">3.2</A> <A class="idx" href="#idx:threadpoolcreate3:63">3.7.2</A></DD>
<DT>throw/1</DT>
<DD>
<A class="idx" href="#idx:throw1:27">3.1.1</A></DD>
<DT>tspy/1</DT>
<DD>
<A class="idx" href="#idx:tspy1:58">3.7</A></DD>
<DT><STRONG>W</STRONG></DT>
<DD>
</DD>
<DT>www_form_encode/2</DT>
<DD>
<A class="idx" href="#idx:wwwformencode2:83">3.12</A></DD>
<DT><STRONG>X</STRONG></DT>
<DD>
</DD>
<DT><A class="idx" href="#xhtml_ns/2">xhtml_ns/2</A></DT>
<DD>
</DD>
</DL>

</BODY></HTML>